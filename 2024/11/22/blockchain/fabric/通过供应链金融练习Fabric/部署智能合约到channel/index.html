<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="部署新的智能合约到channel 部署V1版本 打包 1peer lifecycle chaincode package supply.tar.gz --path &#x2F;Users&#x2F;apple&#x2F;code&#x2F;open-source&#x2F;blockchain&#x2F;hyperledger&#x2F;supply-finance&#x2F;chaincode-go&#x2F; --lang golang --label supply_1.0 运行完">
<meta property="og:type" content="article">
<meta property="og:title" content="部署新的智能合约到channel">
<meta property="og:url" content="https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/index.html">
<meta property="og:site_name" content="滴水成涓">
<meta property="og:description" content="部署新的智能合约到channel 部署V1版本 打包 1peer lifecycle chaincode package supply.tar.gz --path &#x2F;Users&#x2F;apple&#x2F;code&#x2F;open-source&#x2F;blockchain&#x2F;hyperledger&#x2F;supply-finance&#x2F;chaincode-go&#x2F; --lang golang --label supply_1.0 运行完">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/guozhe001/oss/image-20201230151742496-20201230173424532.png">
<meta property="article:published_time" content="2024-11-22T06:32:06.496Z">
<meta property="article:modified_time" content="2024-11-22T06:32:06.496Z">
<meta property="article:author" content="guozhe">
<meta property="article:tag" content="blockchain">
<meta property="article:tag" content="Hyperledger-Fabric">
<meta property="article:tag" content="peer">
<meta property="article:tag" content="chaincode">
<meta property="article:tag" content="供应链金融">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/guozhe001/oss/image-20201230151742496-20201230173424532.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>部署新的智能合约到channel</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="滴水成涓" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E8%AE%BE%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/ClientIdentity%E6%8E%A5%E5%8F%A3%E7%BB%83%E4%B9%A0/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&text=部署新的智能合约到channel"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&is_video=false&description=部署新的智能合约到channel"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=部署新的智能合约到channel&body=Check out this article: https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&name=部署新的智能合约到channel&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&t=部署新的智能合约到channel"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%96%B0%E7%9A%84%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel"><span class="toc-number">1.</span> <span class="toc-text">部署新的智能合约到channel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2V1%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">部署V1版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85"><span class="toc-number">1.1.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v2"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93"><span class="toc-number">1.1.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81"><span class="toc-number">1.1.5.</span> <span class="toc-text">调用链码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="toc-number">1.2.</span> <span class="toc-text">更新智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v2"><span class="toc-number">1.2.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v2"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v3"><span class="toc-number">1.2.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v4"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v2"><span class="toc-number">1.2.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v2"><span class="toc-number">1.2.5.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E4%BA%A4%E6%98%93%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.6.</span> <span class="toc-text">调用交易方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">问题记录：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2v6%E7%89%88%E6%9C%AC%E7%9A%84supply"><span class="toc-number">1.4.</span> <span class="toc-text">部署v6版本的supply</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v6%E7%89%88%E6%9C%AC%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">v6版本智能合约源码如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v3"><span class="toc-number">1.4.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v3"><span class="toc-number">1.4.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v5"><span class="toc-number">1.4.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v3"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v6"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v3"><span class="toc-number">1.4.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v3"><span class="toc-number">1.4.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C-v2"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E4%BA%A4%E6%98%93%E6%96%B9%E6%B3%95-v2"><span class="toc-number">1.4.7.</span> <span class="toc-text">调用交易方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2v7%E7%89%88%E6%9C%AC%E7%9A%84supply"><span class="toc-number">1.5.</span> <span class="toc-text">部署v7版本的supply</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v7%E7%89%88%E6%9C%AC%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.5.1.</span> <span class="toc-text">v7版本智能合约源码如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v4"><span class="toc-number">1.5.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v4"><span class="toc-number">1.5.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v7"><span class="toc-number">1.5.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v4"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v8"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v4"><span class="toc-number">1.5.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v4"><span class="toc-number">1.5.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C-v3"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B9%8B%E9%97%B4%E7%9A%84channel"><span class="toc-number">1.6.</span> <span class="toc-text">创建一级供应商与二级供应商之间的channel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%80%9A%E9%81%93%EF%BC%9A"><span class="toc-number">1.6.1.</span> <span class="toc-text">创建通道：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E5%92%8C%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.</span> <span class="toc-text">把一级供应商和二级供应商的peer加入通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.1.</span> <span class="toc-text">一级供应商的peer加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF%E7%A1%AE%E8%AE%A4%E5%8A%A0%E5%85%A5%E6%88%90%E5%8A%9F"><span class="toc-number">1.7.2.</span> <span class="toc-text">通过获取通道信息确认加入成功</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">获取通道信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.3.</span> <span class="toc-text">二级供应商1加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.4.</span> <span class="toc-text">二级供应商2加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.</span> <span class="toc-text">设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BAGylFOrg1MSP%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">为GylFOrg1MSP设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84channel%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97"><span class="toc-number">1.7.5.1.1.</span> <span class="toc-text">拉取最新的channel配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97"><span class="toc-number">1.7.5.1.2.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A"><span class="toc-number">1.7.5.1.3.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D"><span class="toc-number">1.7.5.1.4.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF-peer-channel-getinfo-c-firstandsecondchannel"><span class="toc-number">1.7.5.1.5.</span> <span class="toc-text">验证，获取通道信息:peer channel getinfo -c firstandsecondchannel</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%EF%BC%88GylSOrg1MSP%EF%BC%89%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">为二级供应商1（GylSOrg1MSP）设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97-v2"><span class="toc-number">1.7.5.2.1.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A-v2"><span class="toc-number">1.7.5.2.2.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D-v2"><span class="toc-number">1.7.5.2.3.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.5.2.4.</span> <span class="toc-text">验证，获取通道信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%EF%BC%88GylSOrg2MSP%EF%BC%89%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">为二级供应商2（GylSOrg2MSP）设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97-v3"><span class="toc-number">1.7.5.3.1.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A-v3"><span class="toc-number">1.7.5.3.2.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D-v3"><span class="toc-number">1.7.5.3.3.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF-v2"><span class="toc-number">1.7.5.3.4.</span> <span class="toc-text">验证，获取通道信息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v7%E5%88%B0%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E8%8A%82%E7%82%B9"><span class="toc-number">1.8.</span> <span class="toc-text">部署supply-v7到二级供应商的peer节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v5"><span class="toc-number">1.8.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v5"><span class="toc-number">1.8.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v9"><span class="toc-number">1.8.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v5"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v10"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v5"><span class="toc-number">1.8.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v5"><span class="toc-number">1.8.5.</span> <span class="toc-text">调用链码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BC%81%E4%B8%9A%E3%80%81%E4%B8%80%E7%BA%A7%E5%92%8C%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E5%8A%A0%E5%85%A5%E5%90%8C%E4%B8%80%E4%B8%AAchannel"><span class="toc-number">1.9.</span> <span class="toc-text">核心企业、一级和二级供应商加入同一个channel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v7%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.10.</span> <span class="toc-text">部署supply-v7到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v6"><span class="toc-number">1.10.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v6"><span class="toc-number">1.10.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v11"><span class="toc-number">1.10.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v6"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v12"><span class="toc-number">1.10.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v6"><span class="toc-number">1.10.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v6"><span class="toc-number">1.10.5.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81-v2"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7"><span class="toc-number">1.10.5.2.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E4%BA%A4%E6%98%93"><span class="toc-number">1.10.5.3.</span> <span class="toc-text">一级供应商与二级供应商1交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v2"><span class="toc-number">1.10.5.4.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93"><span class="toc-number">1.10.5.5.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93-v2"><span class="toc-number">1.10.5.6.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v8%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.11.</span> <span class="toc-text">部署supply-v8到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.11.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v7"><span class="toc-number">1.11.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v7"><span class="toc-number">1.11.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v13"><span class="toc-number">1.11.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v7"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v14"><span class="toc-number">1.11.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v7"><span class="toc-number">1.11.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v7"><span class="toc-number">1.11.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81-v3"><span class="toc-number">1.11.6.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v3"><span class="toc-number">1.11.6.2.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E4%BA%A4%E6%98%93-v2"><span class="toc-number">1.11.6.3.</span> <span class="toc-text">一级供应商与二级供应商1交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v4"><span class="toc-number">1.11.6.4.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93-v3"><span class="toc-number">1.11.6.5.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E9%87%91%E9%A2%9D%E5%A4%A7%E4%BA%8E%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%E7%9A%84%E9%87%91%E9%A2%9D-%E6%9C%9F%E5%BE%85%E9%94%99%E8%AF%AF"><span class="toc-number">1.11.7.</span> <span class="toc-text">转账金额大于凭证资产的金额(期待错误)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E9%87%91%E9%A2%9D%E7%AD%89%E4%BA%8E%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%E7%9A%84%E9%87%91%E9%A2%9D%EF%BC%88%E5%8F%98%E6%9B%B4owner%EF%BC%8C%E4%B8%8D%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%EF%BC%89"><span class="toc-number">1.11.8.</span> <span class="toc-text">转账金额等于凭证资产的金额（变更owner，不产生新的凭证资产）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v9%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.12.</span> <span class="toc-text">部署supply-v9到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-v2"><span class="toc-number">1.12.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v8"><span class="toc-number">1.12.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v8"><span class="toc-number">1.12.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v15"><span class="toc-number">1.12.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v8"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v16"><span class="toc-number">1.12.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v8"><span class="toc-number">1.12.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v8"><span class="toc-number">1.12.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%B5%84%E4%BA%A7"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">删除资产</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v9-1%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.13.</span> <span class="toc-text">部署supply-v9.1到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-v3"><span class="toc-number">1.13.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v9"><span class="toc-number">1.13.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v9"><span class="toc-number">1.13.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v17"><span class="toc-number">1.13.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v9"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v18"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v9"><span class="toc-number">1.13.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v9"><span class="toc-number">1.13.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%B5%84%E4%BA%A7-v2"><span class="toc-number">1.13.6.1.</span> <span class="toc-text">删除资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E4%B9%8B%E5%90%8E%E6%9F%A5%E8%AF%A2%EF%BC%9A"><span class="toc-number">1.13.6.2.</span> <span class="toc-text">删除之后查询：</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        部署新的智能合约到channel
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">guozhe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-22T06:32:06.496Z" itemprop="datePublished">2024-11-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">blockchain</a> › <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/Hyperledger-Fabric/">Hyperledger-Fabric</a> › <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/Hyperledger-Fabric/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E8%B7%B5-%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D/">项目实践-供应链金融</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Hyperledger-Fabric/" rel="tag">Hyperledger-Fabric</a>, <a class="tag-link-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">blockchain</a>, <a class="tag-link-link" href="/tags/chaincode/" rel="tag">chaincode</a>, <a class="tag-link-link" href="/tags/peer/" rel="tag">peer</a>, <a class="tag-link-link" href="/tags/%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D/" rel="tag">供应链金融</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="部署新的智能合约到channel">部署新的智能合约到channel</h1>
<h2 id="部署V1版本">部署V1版本</h2>
<h3 id="打包">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_1.0</span><br></pre></td></tr></table></figure>
<p>运行完上面的命令，查看当前目录会发现多了<code>supply.tar.gz</code>包，说明打包成功。</p>
<h3 id="安装链码包">安装链码包</h3>
<p>一级供应商和核心企业都要安装：<br>
核心企业：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.tar.gz --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>一级供应商：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.tar.gz --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>安装成功输出结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:12:37.540 CST [cli.lifecycle.chaincode] submitInstallProposal -&gt; INFO 001 Installed remotely: response:&lt;status:200 payload:&quot;\nKsupply_1.0:7f51b70454bfcc78087a784c84288a67bbad56786e4007c3a7106491a492ad3a\022\nsupply_1.0&quot; &gt;</span><br><span class="line">2020-12-28 17:12:37.542 CST [cli.lifecycle.chaincode] submitInstallProposal -&gt; INFO 002 Chaincode code package identifier: supply_1.0:7f51b70454bfcc78087a784c84288a67bbad56786e4007c3a7106491a492ad3a</span><br></pre></td></tr></table></figure>
<h3 id="批准链码定义">批准链码定义</h3>
<h4 id="查看已经安装的chaincode">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Installed chaincodes on peer:</span><br><span class="line">Package ID: basic_1.0:4ec191e793b27e953ff2ede5a8bcc63152cecb1e4c3f301a26e22692c61967ad, Label: basic_1.0</span><br><span class="line">Package ID: supply_1.0:7f51b70454bfcc78087a784c84288a67bbad56786e4007c3a7106491a492ad3a, Label: supply_1.0</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_1.0:7f51b70454bfcc78087a784c84288a67bbad56786e4007c3a7106491a492ad3a</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v2">批准链码定义</h4>
<p>核心企业和一级供应商都需要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 1.0 --package-id $CC_PACKAGE_ID --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:14:07.090 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [5c192d72135019a4bd6d444231fc95d41b6c7391cbc80a98cb67618f5e7a85c6] committed with status (VALID) at localhost:8053</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID coreandfirstchannel --name supply --version 1.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;approvals&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;GylCoreOrg1MSP&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="attr">&quot;GylFOrg1MSP&quot;</span>: <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在两个组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 1.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:14:57.631 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [1c5e194c62a24b9fe78d51bd7003fce369f01a0b3051f63ed5e1f9ee4f6cf48b] committed with status (VALID) at localhost:8051</span><br><span class="line">2020-12-28 17:14:57.631 CST [chaincodeCmd] ClientWait -&gt; INFO 002 txid [1c5e194c62a24b9fe78d51bd7003fce369f01a0b3051f63ed5e1f9ee4f6cf48b] committed with status (VALID) at localhost:8053</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID coreandfirstchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Committed chaincode definition for chaincode &#x27;supply&#x27; on channel &#x27;coreandfirstchannel&#x27;:</span><br><span class="line">Version: 1.0, Sequence: 1, Endorsement Plugin: escc, Validation Plugin: vscc, Approvals: [GylCoreOrg1MSP: true, GylFOrg1MSP: true]</span><br></pre></td></tr></table></figure>
<h3 id="调用链码">调用链码</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;100&quot;, &quot;一级供应商&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-25 17:26:22.583 CST [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 001 Chaincode invoke successful. result: status:200</span><br></pre></td></tr></table></figure>
<p><strong>错误信息记录：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: could not assemble transaction: ProposalResponsePayloads do not match - proposal response: version:1 response:&lt;status:200 &gt; payload:&quot;\n \266\367\033\202\030f\357\010\266zg\350\237\212\313 \342B\2041\316\351&gt;H\037\035\312\274J\021i\220\022\266\002\n\237\002\0227\n\n_lifecycle\022)\n&#x27;\n!namespaces/fields/supply/Sequence\022\002\010\t\022\343\001\n\006supply\022\330\001\n\003\n\0011\032\320\001\n\0011\032\312\001&#123;\&quot;ID\&quot;:\&quot;1\&quot;,\&quot;issuer\&quot;:\&quot;\346\240\270\345\277\203\344\274\201\344\270\232\&quot;,\&quot;owner\&quot;:\&quot;\346\240\270\345\277\203\344\274\201\344\270\232\&quot;,\&quot;amount\&quot;:100,\&quot;createDate\&quot;:\&quot;2020-12-28T09:24:44.871052163Z\&quot;,\&quot;endDate\&quot;:\&quot;2021-06-28T09:24:44.871052228Z\&quot;,\&quot;contractHash\&quot;:\&quot;test\&quot;,\&quot;invoiceHash\&quot;:\&quot;test\&quot;&#125;\032\003\010\310\001\&quot;\r\022\006supply\032\0031.0&quot; endorsement:&lt;endorser:&quot;\n\013GylFOrg1MSP\022\212\006-----BEGIN CERTIFICATE-----\nMIICETCCAbegAwIBAgIRAKxyUt8FsMI4LRaMcjh08ZgwCgYIKoZIzj0EAwIwbTEL\nMAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG\ncmFuY2lzY28xFjAUBgNVBAoTDWYxLnN1cHBseS5jb20xGTAXBgNVBAMTEGNhLmYx\nLnN1cHBseS5jb20wHhcNMjAxMjI1MDkxNzAwWhcNMzAxMjIzMDkxNzAwWjBYMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEcMBoGA1UEAxMTcGVlcjAuZjEuc3VwcGx5LmNvbTBZMBMGByqGSM49\nAgEGCCqGSM49AwEHA0IABIChG5EnW6enlGqH2F9EiWYbilBwfA+KgqqxnN56njS5\ngv368PElfoafV6jCrjA+p2OnbTI3gO2/RAwr2WBLB0+jTTBLMA4GA1UdDwEB/wQE\nAwIHgDAMBgNVHRMBAf8EAjAAMCsGA1UdIwQkMCKAIHNOBiXoFslrjdFMBMzU7pNe\nI5pmxxrQGrWTdgfI0cetMAoGCCqGSM49BAMCA0gAMEUCIQDEOKc114LvsauKzrMR\n7k6ipg0HPM1+W8JJt06Jeqd1vwIgBre+xg2g/rS7F5oZaJpECUf7ALV0fy9/Dhw0\nYDB3H+g=\n-----END CERTIFICATE-----\n&quot; signature:&quot;0D\002 9\020\212\014\220\302Ao_\226n`o\005\354B\263\316\346\330\347\010\217\205^X\&quot;\267d\320U\365\002 \t&lt;\024e\324\312X\036\346=\025.I*A\311\223\013\301\276\320\232\366\246tZm\341g\223\235|&quot; &gt;</span><br></pre></td></tr></table></figure>
<p>原因应该是代码中使用了Now（）来创建当前时间，两个peer的当前时间可能会有一点误差导致了校验不通过。</p>
<p>**解决方案：**使用<code>ctx.GetStub().GetTxTimestamp()</code>来获取时间，这样所有的节点创建的时间都是一致的，详见<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55289283/hyperledger-fabric-error-could-not-assemble-transaction-proposalresponsepaylo/61727958">参考文档</a></p>
<h2 id="更新智能合约">更新智能合约</h2>
<h3 id="打包-v2">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> peer lifecycle chaincode package supply.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/fabric-samples/asset-transfer-basic/chaincode-go/ --lang golang --label supply_1.0</span></span><br></pre></td></tr></table></figure>
<p>打包本地的代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.5.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_5.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v2">安装链码包</h3>
<p>一级供应商和核心企业都要安装：<br>
核心企业：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.5.tar.gz --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>一级供应商：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.5.tar.gz --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<h3 id="批准链码定义-v3">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v2">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_5.0:0006888ea72e1b318238518b719382d440ab72f2d2c45b22e674f4828b7f7f9c</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v4">批准链码定义</h4>
<p>核心企业和一级供应商都需要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 5.0 --package-id $CC_PACKAGE_ID --sequence 5 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:58:55.313 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [c4974d5c90ae4fb3bd31f179292d9943dd05aac47248f33e365d9f32ccb5ccb6] committed with status (VALID) at localhost:8051</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v2">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID coreandfirstchannel --name supply --version 5.0 --sequence 5 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;approvals&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;GylCoreOrg1MSP&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="attr">&quot;GylFOrg1MSP&quot;</span>: <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在两个组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 5.0 --sequence 5 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:51:08.452 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [87bc060e5ccdf4014cd4cf34bbbeb5d2ea10c4ff8ebb6f444d10580e2de2da50] committed with status (VALID) at localhost:8053</span><br><span class="line">2020-12-28 17:51:08.460 CST [chaincodeCmd] ClientWait -&gt; INFO 002 txid [87bc060e5ccdf4014cd4cf34bbbeb5d2ea10c4ff8ebb6f444d10580e2de2da50] committed with status (VALID) at localhost:8051</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID coreandfirstchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下,可以看到已经升级到2.0版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Committed chaincode definition for chaincode &#x27;supply&#x27; on channel &#x27;coreandfirstchannel&#x27;:</span><br><span class="line">Version: 2.0, Sequence: 2, Endorsement Plugin: escc, Validation Plugin: vscc, Approvals: [GylCoreOrg1MSP: true, GylFOrg1MSP: true]</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v2">调用链码</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;100&quot;, &quot;一级供应商&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 18:37:54.285 CST [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 001 Chaincode invoke successful. result: status:200</span><br></pre></td></tr></table></figure>
<p><strong>错误信息如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: could not assemble transaction: proposal response was not successful, error code 500, msg Incorrect number of params. Expected 2, received 1 - proposal response: version:1 response:&lt;status:200 &gt; payload:&quot;\n \177\017\350[\344G6\010V\331\332\377\354\216&amp;\035\317&amp;\251[N`\023\036\033\237\237A\005\3670\260\022\266\002\n\237\002\0227\n\n_lifecycle\022)\n&#x27;\n!namespaces/fields/supply/Sequence\022\002\010\016\022\343\001\n\006supply\022\330\001\n\003\n\0011\032\320\001\n\0011\032\312\001&#123;\&quot;ID\&quot;:\&quot;1\&quot;,\&quot;issuer\&quot;:\&quot;\346\240\270\345\277\203\344\274\201\344\270\232\&quot;,\&quot;owner\&quot;:\&quot;\346\240\270\345\277\203\344\274\201\344\270\232\&quot;,\&quot;amount\&quot;:100,\&quot;createDate\&quot;:\&quot;2020-12-28T10:02:30.578872398Z\&quot;,\&quot;endDate\&quot;:\&quot;2021-06-28T10:02:30.578872527Z\&quot;,\&quot;contractHash\&quot;:\&quot;test\&quot;,\&quot;invoiceHash\&quot;:\&quot;test\&quot;&#125;\032\003\010\310\001\&quot;\r\022\006supply\032\0033.0&quot; endorsement:&lt;endorser:&quot;\n\016GylCoreOrg1MSP\022\222\006-----BEGIN CERTIFICATE-----\nMIICFjCCAbygAwIBAgIQU43L5gjtXO+uCpRP2jG2AjAKBggqhkjOPQQDAjBxMQsw\nCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy\nYW5jaXNjbzEYMBYGA1UEChMPY29yZS5zdXBwbHkuY29tMRswGQYDVQQDExJjYS5j\nb3JlLnN1cHBseS5jb20wHhcNMjAxMjI1MDkxNzAwWhcNMzAxMjIzMDkxNzAwWjBa\nMQswCQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2Fu\nIEZyYW5jaXNjbzEeMBwGA1UEAxMVcGVlcjAuY29yZS5zdXBwbHkuY29tMFkwEwYH\nKoZIzj0CAQYIKoZIzj0DAQcDQgAErf3R+7XpNQpmTsMO+iM4WS7IrOoafiPbAS7Q\nbuFFR3Qs4riIczgSmjh9rOA6I1q2q0CstLhfWDbqpf+8fXPUlKNNMEswDgYDVR0P\nAQH/BAQDAgeAMAwGA1UdEwEB/wQCMAAwKwYDVR0jBCQwIoAguznqsTisa64dNvOR\nvPwP0KGklWohNpbSe7VgIghx4L8wCgYIKoZIzj0EAwIDSAAwRQIhALIw1VMzezCg\n9LONbO4+V+weY42HQLbShkTP/gCFnGRYAiARyLLSDJIC2wwzSvOHNdm+aDRtbqGC\nNJenP9hmEbYsTw==\n-----END CERTIFICATE-----\n&quot; signature:&quot;0E\002!\000\251\370K6S\020\373\242\321\000\211\312\0001\333\365&gt;\314\324\231\020&gt;u;+\243\303dD\023\221\237\002 z \224\236R\355Z\251\202\363\035\304\365\212\277\235\375?\376\030\371\236\220\354iG6\244\334M\315\331&quot; &gt;</span><br></pre></td></tr></table></figure>
<p>原因是因为下图，只有一个组织的链码更新到了最新的版本。</p>
<p>![截屏2020-12-28 18.03.06](/Users/apple/Desktop/截屏2020-12-28 18.03.06.png)</p>
<p>**解决方案：**原因是因为设置环境变量<code>CC_PACKAGE_ID</code>时只设置了一个组织的peer，导致旧的环境变量还在生效，重新操作一遍问题解决。</p>
<h4 id="查询调用后的结果">查询调用后的结果</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C coreandfirstchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功结果如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 核心企业</span></span><br><span class="line">[&#123;&quot;ID&quot;:&quot;asset001&quot;,&quot;issuer&quot;:&quot;核心企业&quot;,&quot;owner&quot;:&quot;核心企业&quot;,&quot;amount&quot;:100,&quot;createDate&quot;:&quot;2020-12-28T10:37:54.271518Z&quot;,&quot;endDate&quot;:&quot;2021-06-28T10:37:54.271518Z&quot;,&quot;contractHash&quot;:&quot;test&quot;,&quot;invoiceHash&quot;:&quot;test&quot;&#125;]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一级供应商</span></span><br><span class="line">[&#123;&quot;ID&quot;:&quot;asset001&quot;,&quot;issuer&quot;:&quot;核心企业&quot;,&quot;owner&quot;:&quot;核心企业&quot;,&quot;amount&quot;:100,&quot;createDate&quot;:&quot;2020-12-28T10:37:54.271518Z&quot;,&quot;endDate&quot;:&quot;2021-06-28T10:37:54.271518Z&quot;,&quot;contractHash&quot;:&quot;test&quot;,&quot;invoiceHash&quot;:&quot;test&quot;&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="调用交易方法">调用交易方法</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAsset&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;一级供应商&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>再次查询：<code>peer chaincode query -C coreandfirstchannel -n supply -c '&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;'</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 核心企业</span></span><br><span class="line">[&#123;&quot;ID&quot;:&quot;asset001&quot;,&quot;issuer&quot;:&quot;核心企业&quot;,&quot;owner&quot;:&quot;一级供应商&quot;,&quot;amount&quot;:100,&quot;createDate&quot;:&quot;2020-12-28T10:37:54.271518Z&quot;,&quot;endDate&quot;:&quot;2021-06-28T10:37:54.271518Z&quot;,&quot;contractHash&quot;:&quot;test&quot;,&quot;invoiceHash&quot;:&quot;test&quot;&#125;]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 一级供应商</span></span><br><span class="line">[&#123;&quot;ID&quot;:&quot;asset001&quot;,&quot;issuer&quot;:&quot;核心企业&quot;,&quot;owner&quot;:&quot;一级供应商&quot;,&quot;amount&quot;:100,&quot;createDate&quot;:&quot;2020-12-28T10:37:54.271518Z&quot;,&quot;endDate&quot;:&quot;2021-06-28T10:37:54.271518Z&quot;,&quot;contractHash&quot;:&quot;test&quot;,&quot;invoiceHash&quot;:&quot;test&quot;&#125;]</span><br></pre></td></tr></table></figure>
<p>交易之后owner变成了一级供应商，没有问题。</p>
<h2 id="问题记录：">问题记录：</h2>
<p>虽然智能合约的代码编写方式如下，但是第二行的<code>TransferAsset</code>并没有执行，可能是因为第一个创建交易（CreateAsset）还没有成功，所以第二个交易（TransferAsset）没有这个资产所以没有执行？待确认</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建资产</span></span><br><span class="line">s.CreateAsset(ctx, assetID, amount)</span><br><span class="line">s.TransferAsset(ctx, assetID, owner)</span><br></pre></td></tr></table></figure>
<h2 id="部署v6版本的supply">部署v6版本的supply</h2>
<h3 id="v6版本智能合约源码如下：">v6版本智能合约源码如下：</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chaincode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/ptypes&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-contract-api-go/contractapi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SmartContract provides functions for managing an Asset</span></span><br><span class="line"><span class="keyword">type</span> SmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">	contractapi.Contract</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Asset describes basic details of what makes up a simple asset</span></span><br><span class="line"><span class="keyword">type</span> Asset <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID           <span class="keyword">string</span>    <span class="string">`json:&quot;ID&quot;`</span></span><br><span class="line">	Issuer       <span class="keyword">string</span>    <span class="string">`json:&quot;issuer&quot;`</span></span><br><span class="line">	Owner        <span class="keyword">string</span>    <span class="string">`json:&quot;owner&quot;`</span></span><br><span class="line">	Amount       <span class="keyword">int64</span>     <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	CreateDate   time.Time <span class="string">`json:&quot;createDate&quot;`</span></span><br><span class="line">	EndDate      time.Time <span class="string">`json:&quot;endDate&quot;`</span></span><br><span class="line">	ContractHash <span class="keyword">string</span>    <span class="string">`json:&quot;contractHash&quot;`</span></span><br><span class="line">	InvoiceHash  <span class="keyword">string</span>    <span class="string">`json:&quot;invoiceHash&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IssueVoucher 发行凭证</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">IssueVoucher</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, amount <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建资产</span></span><br><span class="line">	asset, err := s.createAsset(ctx, assetID, amount, <span class="string">&quot;核心企业&quot;</span>, <span class="string">&quot;核心企业&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createAsset issues a new asset to the world state with given details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">createAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, amount <span class="keyword">int64</span>, issuerName <span class="keyword">string</span>, owner <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	exists, err := s.AssetExists(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> exists &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s already exists&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line">	now, err := getNow(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	asset := Asset&#123;ID: id, Issuer: issuerName, Amount: amount, Owner: owner, CreateDate: now,</span><br><span class="line">		EndDate: now.AddDate(<span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>), ContractHash: <span class="string">&quot;test&quot;</span>, InvoiceHash: <span class="string">&quot;test&quot;</span>&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNow</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">(time.Time, error)</span></span> &#123;</span><br><span class="line">	now, err := ctx.GetStub().GetTxTimestamp()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> time.Now(), err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ptypes.Timestamp(now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadAsset returns the asset stored in the world state with given id.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">ReadAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> assetJSON == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s does not exist&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> asset Asset</span><br><span class="line">	err = json.Unmarshal(assetJSON, &amp;asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssetExists returns true when asset with given ID exists in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AssetExists</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assetJSON != <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAsset updates the owner field of asset with given id in world state.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, newOwner <span class="keyword">string</span>, amount <span class="keyword">int64</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 如果金额刚好等于凭证资产的金额，直接更新凭证资产的拥有者</span></span><br><span class="line">	<span class="keyword">if</span> asset.Amount == amount &#123;</span><br><span class="line">		asset.Owner = newOwner</span><br><span class="line">		err = s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &gt; amount &#123; <span class="comment">// 如果凭证资产的金额大于转账的金额，则创建一个新的资产</span></span><br><span class="line">		<span class="comment">// 创建新的资产并保存</span></span><br><span class="line">		newAsset, err := s.createAsset(ctx, asset.ID+<span class="string">&quot;1&quot;</span>, amount, asset.Issuer, newOwner)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		err = s.PutState(ctx, newAsset)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 更新旧资产的金额</span></span><br><span class="line">		asset.Amount = asset.Amount - amount</span><br><span class="line">		err = s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &lt; amount &#123; <span class="comment">// 如果资产的额度小于要转账的金额，则直接报错</span></span><br><span class="line">		err = fmt.Errorf(<span class="string">&quot;转账金额=%d,不能超过资产的金额=%d&quot;</span>, amount, asset.Amount)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PutState 更新资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">PutState</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	assetJSON, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().PutState(asset.ID, assetJSON)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllAssets returns all assets found in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetAllAssets</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">([]*Asset, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// range query with empty string for startKey and endKey does an</span></span><br><span class="line">	<span class="comment">// open-ended query of all assets in the chaincode namespace.</span></span><br><span class="line">	resultsIterator, err := ctx.GetStub().GetStateByRange(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> assets []*Asset</span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> asset Asset</span><br><span class="line">		err = json.Unmarshal(queryResponse.Value, &amp;asset)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		assets = <span class="built_in">append</span>(assets, &amp;asset)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assets, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="打包-v3">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.6.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_6.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v3">安装链码包</h3>
<p>一级供应商和核心企业都要安装：<br>
核心企业：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.6.tar.gz --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>一级供应商：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.6.tar.gz --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<h3 id="批准链码定义-v5">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v3">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_6.0:18a7379ed3b12a57961a735880a71bea3dd242c741fa0970f779b5a338f848de</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v6">批准链码定义</h4>
<p>核心企业和一级供应商都需要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 6.0 --package-id $CC_PACKAGE_ID --sequence 6 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:58:55.313 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [c4974d5c90ae4fb3bd31f179292d9943dd05aac47248f33e365d9f32ccb5ccb6] committed with status (VALID) at localhost:8051</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v3">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID coreandfirstchannel --name supply --version 6.0 --sequence 6 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="attr">&quot;approvals&quot;</span>: &#123;</span><br><span class="line">		<span class="attr">&quot;GylCoreOrg1MSP&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">		<span class="attr">&quot;GylFOrg1MSP&quot;</span>: <span class="literal">true</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在两个组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 6.0 --sequence 6 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>成功结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-28 17:51:08.452 CST [chaincodeCmd] ClientWait -&gt; INFO 001 txid [87bc060e5ccdf4014cd4cf34bbbeb5d2ea10c4ff8ebb6f444d10580e2de2da50] committed with status (VALID) at localhost:8053</span><br><span class="line">2020-12-28 17:51:08.460 CST [chaincodeCmd] ClientWait -&gt; INFO 002 txid [87bc060e5ccdf4014cd4cf34bbbeb5d2ea10c4ff8ebb6f444d10580e2de2da50] committed with status (VALID) at localhost:8051</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID coreandfirstchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功结果如下,可以看到已经升级到2.0版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Committed chaincode definition for chaincode &#x27;supply&#x27; on channel &#x27;coreandfirstchannel&#x27;:</span><br><span class="line">Version: 2.0, Sequence: 2, Endorsement Plugin: escc, Validation Plugin: vscc, Approvals: [GylCoreOrg1MSP: true, GylFOrg1MSP: true]</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v3">调用链码</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset002&quot;, &quot;1000&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 10:59:48.513 CST [chaincodeCmd] chaincodeInvokeOrQuery -&gt; INFO 001 Chaincode invoke successful. result: status:200</span><br></pre></td></tr></table></figure>
<p><strong>错误信息如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: endorsement failure during invoke. response: status:500 message:&quot;the asset asset001 already exists&quot;</span><br></pre></td></tr></table></figure>
<p>**解决方案：**原因是以内资产ID为asset001的资产已经存在，修改资产ID参数即可。</p>
<h4 id="查询调用后的结果-v2">查询调用后的结果</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C coreandfirstchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功结果如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-28T10:37:54.271518Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-28T10:37:54.271518Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset002&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T02:59:48.495257Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T02:59:48.495257Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="调用交易方法-v2">调用交易方法</h3>
<p>把凭证资产拆分一部分（200）给一级供应商：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAsset&quot;,&quot;Args&quot;:[&quot;asset002&quot;, &quot;一级供应商&quot;, &quot;200&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>再次查询：<code>peer chaincode query -C coreandfirstchannel -n supply -c '&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;'</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;ID&quot;: &quot;asset001&quot;,</span><br><span class="line">    &quot;issuer&quot;: &quot;核心企业&quot;,</span><br><span class="line">    &quot;owner&quot;: &quot;一级供应商&quot;,</span><br><span class="line">    &quot;amount&quot;: 100,</span><br><span class="line">    &quot;createDate&quot;: &quot;2020-12-28T10:37:54.271518Z&quot;,</span><br><span class="line">    &quot;endDate&quot;: &quot;2021-06-28T10:37:54.271518Z&quot;,</span><br><span class="line">    &quot;contractHash&quot;: &quot;test&quot;,</span><br><span class="line">    &quot;invoiceHash&quot;: &quot;test&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;ID&quot;: &quot;asset002&quot;,</span><br><span class="line">    &quot;issuer&quot;: &quot;核心企业&quot;,</span><br><span class="line">    &quot;owner&quot;: &quot;核心企业&quot;,</span><br><span class="line">    &quot;amount&quot;: 800,</span><br><span class="line">    &quot;createDate&quot;: &quot;2020-12-29T02:59:48.495257Z&quot;,</span><br><span class="line">    &quot;endDate&quot;: &quot;2021-06-29T02:59:48.495257Z&quot;,</span><br><span class="line">    &quot;contractHash&quot;: &quot;test&quot;,</span><br><span class="line">    &quot;invoiceHash&quot;: &quot;test&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;ID&quot;: &quot;asset0021&quot;,</span><br><span class="line">    &quot;issuer&quot;: &quot;核心企业&quot;,</span><br><span class="line">    &quot;owner&quot;: &quot;一级供应商&quot;,</span><br><span class="line">    &quot;amount&quot;: 200,</span><br><span class="line">    &quot;createDate&quot;: &quot;2020-12-29T03:02:49.495789Z&quot;,</span><br><span class="line">    &quot;endDate&quot;: &quot;2021-06-29T03:02:49.495789Z&quot;,</span><br><span class="line">    &quot;contractHash&quot;: &quot;test&quot;,</span><br><span class="line">    &quot;invoiceHash&quot;: &quot;test&quot;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>交易之后，核心企业剩余800的凭证，一级供应商获得一个新的凭证。验证无误。</p>
<h2 id="部署v7版本的supply">部署v7版本的supply</h2>
<h3 id="v7版本智能合约源码如下：">v7版本智能合约源码如下：</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chaincode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/ptypes&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-contract-api-go/contractapi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SmartContract provides functions for managing an Asset</span></span><br><span class="line"><span class="keyword">type</span> SmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">	contractapi.Contract</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Asset describes basic details of what makes up a simple asset</span></span><br><span class="line"><span class="keyword">type</span> Asset <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID           <span class="keyword">string</span>    <span class="string">`json:&quot;ID&quot;`</span></span><br><span class="line">	Issuer       <span class="keyword">string</span>    <span class="string">`json:&quot;issuer&quot;`</span></span><br><span class="line">	Owner        <span class="keyword">string</span>    <span class="string">`json:&quot;owner&quot;`</span></span><br><span class="line">	Amount       <span class="keyword">int64</span>     <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	CreateDate   time.Time <span class="string">`json:&quot;createDate&quot;`</span></span><br><span class="line">	EndDate      time.Time <span class="string">`json:&quot;endDate&quot;`</span></span><br><span class="line">	ContractHash <span class="keyword">string</span>    <span class="string">`json:&quot;contractHash&quot;`</span></span><br><span class="line">	InvoiceHash  <span class="keyword">string</span>    <span class="string">`json:&quot;invoiceHash&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IssueVoucher 发行凭证</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">IssueVoucher</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, amount <span class="keyword">int64</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建资产</span></span><br><span class="line">	<span class="keyword">return</span> s.CreateAssetAndSave(ctx, assetID, amount, <span class="string">&quot;核心企业&quot;</span>, owner, contractHash, invoiceHash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateAssetAndSave 创建资产并保存</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">CreateAssetAndSave</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, amount <span class="keyword">int64</span>, issuerName <span class="keyword">string</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.createAsset(ctx, id, amount, issuerName, owner, contractHash, invoiceHash)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createAsset issues a new asset to the world state with given details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">createAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, amount <span class="keyword">int64</span>, issuerName <span class="keyword">string</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	exists, err := s.AssetExists(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> exists &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s already exists&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line">	now, err := getNow(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	asset := Asset&#123;ID: id, Issuer: issuerName, Amount: amount, Owner: owner, CreateDate: now,</span><br><span class="line">		EndDate: now.AddDate(<span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>), ContractHash: contractHash, InvoiceHash: invoiceHash&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前时间</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNow</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">(time.Time, error)</span></span> &#123;</span><br><span class="line">	now, err := ctx.GetStub().GetTxTimestamp()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> time.Now(), err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ptypes.Timestamp(now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadAsset returns the asset stored in the world state with given id.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">ReadAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> assetJSON == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s does not exist&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> asset Asset</span><br><span class="line">	err = json.Unmarshal(assetJSON, &amp;asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssetExists returns true when asset with given ID exists in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AssetExists</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assetJSON != <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAssetByID 根据资产ID转账</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAssetByID</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, newOwner <span class="keyword">string</span>, amount <span class="keyword">int64</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.TransferAsset(ctx, asset, newOwner, amount, contractHash, invoiceHash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAsset updates the owner field of asset with given id in world state.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset, newOwner <span class="keyword">string</span>, amount <span class="keyword">int64</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 如果金额刚好等于凭证资产的金额，直接更新凭证资产的拥有者</span></span><br><span class="line">	<span class="keyword">if</span> asset.Amount == amount &#123;</span><br><span class="line">		asset.Owner = newOwner</span><br><span class="line">		<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &gt; amount &#123; <span class="comment">// 如果凭证资产的金额大于转账的金额，则创建一个新的资产</span></span><br><span class="line">		<span class="comment">// 创建新的资产并保存</span></span><br><span class="line">		err := s.CreateAssetAndSave(ctx, asset.ID+<span class="string">&quot;1&quot;</span>, amount, asset.Issuer, newOwner, contractHash, invoiceHash)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 更新旧资产的金额</span></span><br><span class="line">		asset.Amount = asset.Amount - amount</span><br><span class="line">		<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &lt; amount &#123; <span class="comment">// 如果资产的额度小于要转账的金额，则直接报错</span></span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;转账金额=%d,不能超过资产的金额=%d&quot;</span>, amount, asset.Amount)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PutState 更新资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">PutState</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	assetJSON, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().PutState(asset.ID, assetJSON)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllAssets returns all assets found in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetAllAssets</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">([]*Asset, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// range query with empty string for startKey and endKey does an</span></span><br><span class="line">	<span class="comment">// open-ended query of all assets in the chaincode namespace.</span></span><br><span class="line">	resultsIterator, err := ctx.GetStub().GetStateByRange(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> assets []*Asset</span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> asset Asset</span><br><span class="line">		err = json.Unmarshal(queryResponse.Value, &amp;asset)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		assets = <span class="built_in">append</span>(assets, &amp;asset)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assets, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="打包-v4">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.7.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_7.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v4">安装链码包</h3>
<p>一级供应商和核心企业都要安装：<br>
核心企业：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.7.tar.gz --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>一级供应商：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.7.tar.gz --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<h3 id="批准链码定义-v7">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v4">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_7.0:770f0c8f4fe3a348314f546594d402ccb3eb5f5779f12e7edee48f6ce474227b</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v8">批准链码定义</h4>
<p>核心企业和一级供应商都需要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 7.0 --package-id $CC_PACKAGE_ID --sequence 7 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v4">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID coreandfirstchannel --name supply --version 7.0 --sequence 7 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在两个组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID coreandfirstchannel --name supply --version 7.0 --sequence 7 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID coreandfirstchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v4">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shasum -a 256 CORE_AND_F1_CONTRACT.txt &gt; core_and_f1_contract_hash.txt</span><br><span class="line">shasum -a 256 CORE_AND_F1_INVOICE.txt &gt; CORE_AND_F1_INVOICE_hash.txt</span><br></pre></td></tr></table></figure>
<h4 id="发行凭证">发行凭证</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C coreandfirstchannel -n supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset003&quot;, &quot;1000&quot;, &quot;一级供应商&quot;, &quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;, &quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="查询调用后的结果-v3">查询调用后的结果</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C coreandfirstchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>成功结果如下</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">100</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-28T10:37:54.271518Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-28T10:37:54.271518Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset002&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">800</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T02:59:48.495257Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T02:59:48.495257Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0021&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T03:02:49.495789Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T03:02:49.495789Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;test&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset003&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T06:20:30.868298Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T06:20:30.868298Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>ID为asset003的资产归属为一级供应商，金额无误。</p>
<h2 id="创建一级供应商与二级供应商之间的channel">创建一级供应商与二级供应商之间的channel</h2>
<h3 id="创建通道：">创建通道：</h3>
<p>运行下面的程序来为<code>firstandsecondchannel</code>通道创建一个“创建通道的交易”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">configtxgen -profile FirstAndSecondChannel -outputCreateChannelTx ./channel-artifacts/firstandsecondchannel.tx -channelID firstandsecondchannel</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:27:37.416 CST [common.tools.configtxgen] main -&gt; INFO 001 Loading configuration</span><br><span class="line">2020-12-29 14:27:37.430 CST [common.tools.configtxgen.localconfig] Load -&gt; INFO 002 Loaded configuration: /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/config/configtx.yaml</span><br><span class="line">2020-12-29 14:27:37.430 CST [common.tools.configtxgen] doOutputChannelCreateTx -&gt; INFO 003 Generating new channel configtx</span><br><span class="line">2020-12-29 14:27:37.436 CST [common.tools.configtxgen] doOutputChannelCreateTx -&gt; INFO 004 Writing new channel tx</span><br></pre></td></tr></table></figure>
<p>设置环境变量，以一级供应商管理员身份操作<code>peer</code>CLI，使用下面的命令把交易发给order服务创建通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel create -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com -c firstandsecondchannel -f ./channel-artifacts/firstandsecondchannel.tx --outputBlock ./channel-artifacts/firstandsecondchannel.block --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p><strong>错误信息记录：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: got unexpected status: BAD_REQUEST -- error validating channel creation transaction for new channel &#x27;firstandsecondchannel&#x27;, could not successfully apply update to template configuration: error authorizing update: error validating DeltaSet: policy for [Group]  /Channel/Application not satisfied: implicit policy evaluation failed - 0 sub-policies were satisfied, but this policy requires 1 of the &#x27;Admins&#x27; sub-policies to be satisfied</span><br></pre></td></tr></table></figure>
<p><strong>错误原因和解决方案：</strong></p>
<p>由于配置文件里面配置的firstandsecondchannel里面包含一级供应商和两个二级供应商，而上面的命令是以核心企业的管理员身份运行的。所以有问题。切换成一级供应商的环境执行即可。</p>
<p>正确执行之后的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:34:06.203 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:06.231 CST [cli.common] readBlock -&gt; INFO 002 Expect block, but got status: &amp;&#123;NOT_FOUND&#125;</span><br><span class="line">2020-12-29 14:34:06.244 CST [channelCmd] InitCmdFactory -&gt; INFO 003 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:06.450 CST [cli.common] readBlock -&gt; INFO 004 Expect block, but got status: &amp;&#123;SERVICE_UNAVAILABLE&#125;</span><br><span class="line">2020-12-29 14:34:06.458 CST [channelCmd] InitCmdFactory -&gt; INFO 005 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:06.667 CST [cli.common] readBlock -&gt; INFO 006 Expect block, but got status: &amp;&#123;SERVICE_UNAVAILABLE&#125;</span><br><span class="line">2020-12-29 14:34:06.676 CST [channelCmd] InitCmdFactory -&gt; INFO 007 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:06.885 CST [cli.common] readBlock -&gt; INFO 008 Expect block, but got status: &amp;&#123;SERVICE_UNAVAILABLE&#125;</span><br><span class="line">2020-12-29 14:34:06.892 CST [channelCmd] InitCmdFactory -&gt; INFO 009 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:07.099 CST [cli.common] readBlock -&gt; INFO 00a Expect block, but got status: &amp;&#123;SERVICE_UNAVAILABLE&#125;</span><br><span class="line">2020-12-29 14:34:07.108 CST [channelCmd] InitCmdFactory -&gt; INFO 00b Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:34:07.320 CST [cli.common] readBlock -&gt; INFO 00c Received block: 0</span><br></pre></td></tr></table></figure>
<h2 id="把一级供应商和二级供应商的peer加入通道">把一级供应商和二级供应商的peer加入通道</h2>
<h3 id="一级供应商的peer加入通道">一级供应商的peer加入通道</h3>
<p>使用下面的命令将peer加入通道</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel join -b ./channel-artifacts/firstandsecondchannel.block</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:35:00.679 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:35:00.724 CST [channelCmd] executeJoin -&gt; INFO 002 Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>
<h3 id="通过获取通道信息确认加入成功">通过获取通道信息确认加入成功</h3>
<h4 id="获取通道信息">获取通道信息</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel getinfo -c firstandsecondchannel</span><br></pre></td></tr></table></figure>
<p>可以看到如下信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:35:28.593 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">Blockchain info: &#123;&quot;height&quot;:1,&quot;currentBlockHash&quot;:&quot;270CWtnSyXJmeGCxJx41sX7uTchRZpljYWKJ48dD434=&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="二级供应商1加入通道">二级供应商1加入通道</h3>
<p>设置环境变量，然后拉取通道的创世纪区块(因为是测试本次忽略)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel fetch 0 ./channel-artifacts/coreandfirstchannel.block -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com -c coreandfirstchannel --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>加入通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel join -b ./channel-artifacts/firstandsecondchannel.block</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:47:03.684 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:47:03.722 CST [channelCmd] executeJoin -&gt; INFO 002 Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>
<p><strong>报错信息如下：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">supply-finance apple$ peer channel join -b ./channel-artifacts/coreandfirstchannel.block</span><br><span class="line">2020-12-29 14:43:56.186 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">Error: proposal failed (err: rpc error: code = Unknown desc = error validating proposal: access denied: channel [] creator org [GylSOrg1M])</span><br></pre></td></tr></table></figure>
<p>**错误原因：**由于环境变量设置的有问题，<code>CORE_PEER_LOCALMSPID</code>设置成了<code>GylSOrg1M</code>，应该设置为<code>GylSOrg1MSP</code></p>
<h3 id="二级供应商2加入通道">二级供应商2加入通道</h3>
<p>设置环境变量，然后拉取通道的创世纪区块(因为是测试本次忽略)：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel fetch 0 ./channel-artifacts/coreandfirstchannel.block -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com -c coreandfirstchannel --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>加入通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel join -b ./channel-artifacts/firstandsecondchannel.block</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:52:12.969 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:52:13.010 CST [channelCmd] executeJoin -&gt; INFO 002 Successfully submitted proposal to join channel</span><br></pre></td></tr></table></figure>
<h3 id="设置锚节点">设置锚节点</h3>
<h4 id="为GylFOrg1MSP设置锚节点">为GylFOrg1MSP设置锚节点</h4>
<h5 id="拉取最新的channel配置区块">拉取最新的channel配置区块</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel fetch config channel-artifacts/firstandsecondchannel_config_block.pb -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com -c firstandsecondchannel --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>成功信息如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:55:57.114 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:55:57.120 CST [cli.common] readBlock -&gt; INFO 002 Received block: 0</span><br><span class="line">2020-12-29 14:55:57.120 CST [channelCmd] fetch -&gt; INFO 003 Retrieving last config block: 0</span><br><span class="line">2020-12-29 14:55:57.125 CST [cli.common] readBlock -&gt; INFO 004 Received block: 0</span><br></pre></td></tr></table></figure>
<h5 id="修改通道配置区块">修改通道配置区块</h5>
<p>切换到<code>channel-artifacts</code>然后把区块内容转换成json格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd channel-artifacts</span><br><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_block.pb --type common.Block --output firstandsecondchannel_config_block.json</span><br><span class="line">jq .data.data[0].payload.data.config firstandsecondchannel_config_block.json &gt; firstandsecondchannel_config.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> copy一份</span></span><br><span class="line">cp firstandsecondchannel_config.json firstandsecondchannel_config_copy.json</span><br></pre></td></tr></table></figure>
<p>使用<code>jq</code> 工具来添加GylFOrg1MSP组织的锚节点到通道配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq &#x27;.channel_group.groups.Application.groups.GylFOrg1MSP.values += &#123;&quot;AnchorPeers&quot;:&#123;&quot;mod_policy&quot;: &quot;Admins&quot;,&quot;value&quot;:&#123;&quot;anchor_peers&quot;: [&#123;&quot;host&quot;: &quot;peer0.f1.supply.com&quot;,&quot;port&quot;: 8053&#125;]&#125;,&quot;version&quot;: &quot;0&quot;&#125;&#125;&#x27; firstandsecondchannel_config_copy.json &gt; modified_firstandsecondchannel_config.json</span><br></pre></td></tr></table></figure>
<p>将原始的和修改后的通道配置都转换回protobuf格式，并计算它们之间的差异。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_encode --input firstandsecondchannel_config.json --type common.Config --output firstandsecondchannel_config.pb</span><br><span class="line">configtxlator proto_encode --input modified_firstandsecondchannel_config.json --type common.Config --output modified_firstandsecondchannel_config.pb</span><br><span class="line">configtxlator compute_update --channel_id firstandsecondchannel --original firstandsecondchannel_config.pb --updated modified_firstandsecondchannel_config.pb --output firstandsecondchannel_config_update.pb</span><br></pre></td></tr></table></figure>
<h5 id="把更新后的交易打包成一个更新通道配置的交易：">把更新后的交易打包成一个更新通道配置的交易：</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_update.pb --type common.ConfigUpdate --output firstandsecondchannel_config_update.json</span><br><span class="line">echo &#x27;&#123;&quot;payload&quot;:&#123;&quot;header&quot;:&#123;&quot;channel_header&quot;:&#123;&quot;channel_id&quot;:&quot;firstandsecondchannel&quot;, &quot;type&quot;:2&#125;&#125;,&quot;data&quot;:&#123;&quot;config_update&quot;:&#x27;$(cat firstandsecondchannel_config_update.json)&#x27;&#125;&#125;&#125;&#x27; | jq . &gt; firstandsecondchannel_config_update_in_envelope.json</span><br><span class="line">configtxlator proto_encode --input firstandsecondchannel_config_update_in_envelope.json --type common.Envelope --output firstandsecondchannel_config_update_in_envelope.pb</span><br></pre></td></tr></table></figure>
<h5 id="提交“更新通道配置的交易”">提交“更新通道配置的交易”</h5>
<p>进到上一级目录<code>cd ..</code>，之后运行命令将交易提交给排序服务进行通道配置的更新：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">peer channel update -f channel-artifacts/firstandsecondchannel_config_update_in_envelope.pb -c firstandsecondchannel -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>执行成功的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:57:48.872 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 14:57:48.894 CST [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span><br></pre></td></tr></table></figure>
<h5 id="验证，获取通道信息-peer-channel-getinfo-c-firstandsecondchannel">验证，获取通道信息:<code>peer channel getinfo -c firstandsecondchannel</code></h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 14:58:15.937 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">Blockchain info: &#123;&quot;height&quot;:2,&quot;currentBlockHash&quot;:&quot;4lhXvhRKDNxBsOIGL0H0A5QDdNkySgv/ehtUkobtW9Y=&quot;,&quot;previousBlockHash&quot;:&quot;270CWtnSyXJmeGCxJx41sX7uTchRZpljYWKJ48dD434=&quot;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="为二级供应商1（GylSOrg1MSP）设置锚节点">为二级供应商1（GylSOrg1MSP）设置锚节点</h4>
<p>修改环境变量，拉取最新的channel配置区块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel fetch config channel-artifacts/firstandsecondchannel_config_block.pb -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com -c firstandsecondchannel --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h5 id="修改通道配置区块-v2">修改通道配置区块</h5>
<p>切换到<code>channel-artifacts</code>然后把区块内容转换成json格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd channel-artifacts</span><br><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_block.pb --type common.Block --output firstandsecondchannel_config_block.json</span><br><span class="line">jq .data.data[0].payload.data.config firstandsecondchannel_config_block.json &gt; firstandsecondchannel_config.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> copy一份</span></span><br><span class="line">cp firstandsecondchannel_config.json firstandsecondchannel_config_copy.json</span><br></pre></td></tr></table></figure>
<p>使用<code>jq</code> 工具来添加GylCoreOrg1MSP组织的锚节点到通道配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq &#x27;.channel_group.groups.Application.groups.GylSOrg1MSP.values += &#123;&quot;AnchorPeers&quot;:&#123;&quot;mod_policy&quot;: &quot;Admins&quot;,&quot;value&quot;:&#123;&quot;anchor_peers&quot;: [&#123;&quot;host&quot;: &quot;peer0.s1.supply.com&quot;,&quot;port&quot;: 8055&#125;]&#125;,&quot;version&quot;: &quot;0&quot;&#125;&#125;&#x27; firstandsecondchannel_config_copy.json &gt; modified_firstandsecondchannel_config.json</span><br></pre></td></tr></table></figure>
<p>将原始的和修改后的通道配置都转换回protobuf格式，并计算它们之间的差异。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_encode --input firstandsecondchannel_config.json --type common.Config --output firstandsecondchannel_config.pb</span><br><span class="line">configtxlator proto_encode --input modified_firstandsecondchannel_config.json --type common.Config --output modified_firstandsecondchannel_config.pb</span><br><span class="line">configtxlator compute_update --channel_id firstandsecondchannel --original firstandsecondchannel_config.pb --updated modified_firstandsecondchannel_config.pb --output firstandsecondchannel_config_update.pb</span><br></pre></td></tr></table></figure>
<h5 id="把更新后的交易打包成一个更新通道配置的交易：-v2">把更新后的交易打包成一个更新通道配置的交易：</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_update.pb --type common.ConfigUpdate --output firstandsecondchannel_config_update.json</span><br><span class="line">echo &#x27;&#123;&quot;payload&quot;:&#123;&quot;header&quot;:&#123;&quot;channel_header&quot;:&#123;&quot;channel_id&quot;:&quot;firstandsecondchannel&quot;, &quot;type&quot;:2&#125;&#125;,&quot;data&quot;:&#123;&quot;config_update&quot;:&#x27;$(cat firstandsecondchannel_config_update.json)&#x27;&#125;&#125;&#125;&#x27; | jq . &gt; firstandsecondchannel_config_update_in_envelope.json</span><br><span class="line">configtxlator proto_encode --input firstandsecondchannel_config_update_in_envelope.json --type common.Envelope --output firstandsecondchannel_config_update_in_envelope.pb</span><br></pre></td></tr></table></figure>
<h5 id="提交“更新通道配置的交易”-v2">提交“更新通道配置的交易”</h5>
<p>进到上一级目录<code>cd ..</code>，之后运行命令将交易提交给排序服务进行通道配置的更新：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">peer channel update -f channel-artifacts/firstandsecondchannel_config_update_in_envelope.pb -c firstandsecondchannel -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>执行成功的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 15:01:14.643 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 15:01:14.670 CST [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span><br></pre></td></tr></table></figure>
<h5 id="验证，获取通道信息">验证，获取通道信息</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(base) w:supply-finance apple$ peer channel getinfo -c firstandsecondchannel</span><br><span class="line">2020-12-29 15:01:26.952 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">Blockchain info: &#123;&quot;height&quot;:3,&quot;currentBlockHash&quot;:&quot;DPXkm090OpH9ww862WmR4EktxT0NHEM2i3Py0yHAGPE=&quot;,&quot;previousBlockHash&quot;:&quot;4lhXvhRKDNxBsOIGL0H0A5QDdNkySgv/ehtUkobtW9Y=&quot;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="为二级供应商2（GylSOrg2MSP）设置锚节点">为二级供应商2（GylSOrg2MSP）设置锚节点</h4>
<p>修改环境变量，拉取最新的channel配置区块</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer channel fetch config channel-artifacts/firstandsecondchannel_config_block.pb -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com -c firstandsecondchannel --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h5 id="修改通道配置区块-v3">修改通道配置区块</h5>
<p>切换到<code>channel-artifacts</code>然后把区块内容转换成json格式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd channel-artifacts</span><br><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_block.pb --type common.Block --output firstandsecondchannel_config_block.json</span><br><span class="line">jq .data.data[0].payload.data.config firstandsecondchannel_config_block.json &gt; firstandsecondchannel_config.json</span><br><span class="line"><span class="meta">#</span><span class="bash"> copy一份</span></span><br><span class="line">cp firstandsecondchannel_config.json firstandsecondchannel_config_copy.json</span><br></pre></td></tr></table></figure>
<p>使用<code>jq</code> 工具来添加GylCoreOrg1MSP组织的锚节点到通道配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jq &#x27;.channel_group.groups.Application.groups.GylSOrg2MSP.values += &#123;&quot;AnchorPeers&quot;:&#123;&quot;mod_policy&quot;: &quot;Admins&quot;,&quot;value&quot;:&#123;&quot;anchor_peers&quot;: [&#123;&quot;host&quot;: &quot;peer0.s2.supply.com&quot;,&quot;port&quot;: 8151&#125;]&#125;,&quot;version&quot;: &quot;0&quot;&#125;&#125;&#x27; firstandsecondchannel_config_copy.json &gt; modified_firstandsecondchannel_config.json</span><br></pre></td></tr></table></figure>
<p>将原始的和修改后的通道配置都转换回protobuf格式，并计算它们之间的差异。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_encode --input firstandsecondchannel_config.json --type common.Config --output firstandsecondchannel_config.pb</span><br><span class="line">configtxlator proto_encode --input modified_firstandsecondchannel_config.json --type common.Config --output modified_firstandsecondchannel_config.pb</span><br><span class="line">configtxlator compute_update --channel_id firstandsecondchannel --original firstandsecondchannel_config.pb --updated modified_firstandsecondchannel_config.pb --output firstandsecondchannel_config_update.pb</span><br></pre></td></tr></table></figure>
<h5 id="把更新后的交易打包成一个更新通道配置的交易：-v3">把更新后的交易打包成一个更新通道配置的交易：</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configtxlator proto_decode --input firstandsecondchannel_config_update.pb --type common.ConfigUpdate --output firstandsecondchannel_config_update.json</span><br><span class="line">echo &#x27;&#123;&quot;payload&quot;:&#123;&quot;header&quot;:&#123;&quot;channel_header&quot;:&#123;&quot;channel_id&quot;:&quot;firstandsecondchannel&quot;, &quot;type&quot;:2&#125;&#125;,&quot;data&quot;:&#123;&quot;config_update&quot;:&#x27;$(cat firstandsecondchannel_config_update.json)&#x27;&#125;&#125;&#125;&#x27; | jq . &gt; firstandsecondchannel_config_update_in_envelope.json</span><br><span class="line">configtxlator proto_encode --input firstandsecondchannel_config_update_in_envelope.json --type common.Envelope --output firstandsecondchannel_config_update_in_envelope.pb</span><br></pre></td></tr></table></figure>
<h5 id="提交“更新通道配置的交易”-v3">提交“更新通道配置的交易”</h5>
<p>进到上一级目录<code>cd ..</code>，之后运行命令将交易提交给排序服务进行通道配置的更新：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ..</span><br><span class="line">peer channel update -f channel-artifacts/firstandsecondchannel_config_update_in_envelope.pb -c firstandsecondchannel -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p>执行成功的结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-12-29 15:03:39.793 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">2020-12-29 15:03:39.817 CST [channelCmd] update -&gt; INFO 002 Successfully submitted channel update</span><br></pre></td></tr></table></figure>
<h5 id="验证，获取通道信息-v2">验证，获取通道信息</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(base) w:supply-finance apple$ peer channel getinfo -c firstandsecondchannel</span><br><span class="line">2020-12-29 15:04:10.414 CST [channelCmd] InitCmdFactory -&gt; INFO 001 Endorser and orderer connections initialized</span><br><span class="line">Blockchain info: &#123;&quot;height&quot;:4,&quot;currentBlockHash&quot;:&quot;PWXXje7tci4mk1ggQ9QMVzkvkP3i+N8WslOGDXreIQ0=&quot;,&quot;previousBlockHash&quot;:&quot;DPXkm090OpH9ww862WmR4EktxT0NHEM2i3Py0yHAGPE=&quot;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="部署supply-v7到二级供应商的peer节点">部署supply-v7到二级供应商的peer节点</h2>
<h3 id="打包-v5">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.7.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_7.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v5">安装链码包</h3>
<p>两个二级供应商都要安装：<br>
二级供应商1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.7.tar.gz --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>二级供应商2：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode install supply.7.tar.gz --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<h3 id="批准链码定义-v9">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v5">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_7.0:770f0c8f4fe3a348314f546594d402ccb3eb5f5779f12e7edee48f6ce474227b</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v10">批准链码定义</h4>
<p>一级供应商和两个二级供应商都需要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID firstandsecondchannel --name supply --version 7.0 --package-id $CC_PACKAGE_ID --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v5">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID firstandsecondchannel --name supply --version 7.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在所有组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID firstandsecondchannel --name supply --version 7.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID firstandsecondchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<p><strong>错误信息记录：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) w:supply-finance apple$ peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID firstandsecondchannel --name supply --version 7.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt</span><br><span class="line">Error: proposal failed with status: 500 - channel &#x27;firstandsecondchannel&#x27; not found</span><br></pre></td></tr></table></figure>
<p>**错误原因：**由于批准的组织中包含核心企业，核心企业并没有加入<code>firstandsecondchannel</code>通道，所以报错。</p>
<h3 id="调用链码-v5">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a  f1_and_s1_contract.txt</span><br><span class="line">792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49  f1_and_s1_invoice.txt</span><br><span class="line">f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb  f1_and_s2_contract.txt</span><br><span class="line">f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468  f1_and_s2_invoice.txt</span><br></pre></td></tr></table></figure>
<p>调用转账交易：TODO 问题来了，两个channel之间如何交换资产？这是个问题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com -C firstandsecondchannel -n supply --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset003&quot;, &quot;1000&quot;, &quot;一级供应商&quot;, &quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;, &quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C firstandsecondchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h2 id="核心企业、一级和二级供应商加入同一个channel">核心企业、一级和二级供应商加入同一个channel</h2>
<p>查看<a href="https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E5%88%9B%E5%BB%BAchannel/">创建channel</a></p>
<h2 id="部署supply-v7到alljoinchannel通道">部署supply-v7到alljoinchannel通道</h2>
<h3 id="打包-v6">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> peer lifecycle chaincode package supply.7.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_7.0</span></span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v6">安装链码包</h3>
<p>每个peer都要安装：<code>peer lifecycle chaincode install supply.7.tar.gz</code></p>
<h3 id="批准链码定义-v11">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v6">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_7.0:770f0c8f4fe3a348314f546594d402ccb3eb5f5779f12e7edee48f6ce474227b</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v12">批准链码定义</h4>
<p>每个peer都要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 7.0 --package-id $CC_PACKAGE_ID --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v6">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID alljoinchannel --name supply --version 7.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在所有组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 7.0 --sequence 1 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID alljoinchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v6">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9  CORE_AND_F1_INVOICE.txt</span><br><span class="line">93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14  CORE_AND_F1_CONTRACT.txt</span><br><span class="line">76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a  f1_and_s1_contract.txt</span><br><span class="line">792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49  f1_and_s1_invoice.txt</span><br><span class="line">f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb  f1_and_s2_contract.txt</span><br><span class="line">f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468  f1_and_s2_invoice.txt</span><br></pre></td></tr></table></figure>
<h4 id="发行凭证-v2">发行凭证</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset003&quot;, &quot;1000&quot;, &quot;一级供应商&quot;, &quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;, &quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="查询资产">查询资产</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C alljoinchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset003&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="一级供应商与二级供应商1交易">一级供应商与二级供应商1交易</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset003&quot;, &quot;二级供应商1&quot;, &quot;500&quot;, &quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;, &quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="查询资产-v2">查询资产</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C alljoinchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset003&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0031&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:12:37.227293Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:12:37.227293Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="一级供应商与二级供应商2交易">一级供应商与二级供应商2交易</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset003&quot;, &quot;二级供应商2&quot;, &quot;300&quot;, &quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;, &quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>错误信息记录：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: endorsement failure during invoke. response: status:500 message:&quot;the asset asset0031 already exists&quot;</span><br></pre></td></tr></table></figure>
<p>原因如下：如果同一个资产ID交易两次，则会出现资产ID重复的问题；代码bug。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := s.CreateAssetAndSave(ctx, asset.ID+<span class="string">&quot;1&quot;</span>, amount, asset.Issuer, newOwner, contractHash, invoiceHash)</span><br></pre></td></tr></table></figure>
<h4 id="一级供应商与二级供应商2交易-v2">一级供应商与二级供应商2交易</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset0031&quot;, &quot;二级供应商2&quot;, &quot;300&quot;, &quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;, &quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>查询资产，结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset003&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:07:43.665003Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0031&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:12:37.227293Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:12:37.227293Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset00311&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-29T10:17:26.148125Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-29T10:17:26.148125Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="部署supply-v8到alljoinchannel通道">部署supply-v8到alljoinchannel通道</h2>
<h3 id="源码">源码</h3>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chaincode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/ptypes&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-contract-api-go/contractapi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// SmartContract provides functions for managing an Asset</span></span><br><span class="line"><span class="keyword">type</span> SmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">	contractapi.Contract</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Asset describes basic details of what makes up a simple asset</span></span><br><span class="line"><span class="keyword">type</span> Asset <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID           <span class="keyword">string</span>    <span class="string">`json:&quot;ID&quot;`</span></span><br><span class="line">	Issuer       <span class="keyword">string</span>    <span class="string">`json:&quot;issuer&quot;`</span></span><br><span class="line">	Owner        <span class="keyword">string</span>    <span class="string">`json:&quot;owner&quot;`</span></span><br><span class="line">	Amount       <span class="keyword">int64</span>     <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	CreateDate   time.Time <span class="string">`json:&quot;createDate&quot;`</span></span><br><span class="line">	EndDate      time.Time <span class="string">`json:&quot;endDate&quot;`</span></span><br><span class="line">	ContractHash <span class="keyword">string</span>    <span class="string">`json:&quot;contractHash&quot;`</span></span><br><span class="line">	InvoiceHash  <span class="keyword">string</span>    <span class="string">`json:&quot;invoiceHash&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IssueVoucher 发行凭证</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">IssueVoucher</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, amount <span class="keyword">int64</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 创建资产</span></span><br><span class="line">	<span class="keyword">return</span> s.CreateAssetAndSave(ctx, assetID, amount, <span class="string">&quot;核心企业&quot;</span>, owner, contractHash, invoiceHash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateAssetAndSave 创建资产并保存</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">CreateAssetAndSave</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, amount <span class="keyword">int64</span>, issuerName <span class="keyword">string</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.createAsset(ctx, id, amount, issuerName, owner, contractHash, invoiceHash)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createAsset issues a new asset to the world state with given details.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">createAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, amount <span class="keyword">int64</span>, issuerName <span class="keyword">string</span>, owner <span class="keyword">string</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	exists, err := s.AssetExists(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> exists &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s already exists&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line">	now, err := getNow(ctx)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	asset := Asset&#123;ID: id, Issuer: issuerName, Amount: amount, Owner: owner, CreateDate: now,</span><br><span class="line">		EndDate: now.AddDate(<span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>), ContractHash: contractHash, InvoiceHash: invoiceHash&#125;</span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取当前时间</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getNow</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">(time.Time, error)</span></span> &#123;</span><br><span class="line">	now, err := ctx.GetStub().GetTxTimestamp()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> time.Now(), err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ptypes.Timestamp(now)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReadAsset returns the asset stored in the world state with given id.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">ReadAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(*Asset, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> assetJSON == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">&quot;the asset %s does not exist&quot;</span>, id)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> asset Asset</span><br><span class="line">	err = json.Unmarshal(assetJSON, &amp;asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;asset, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssetExists returns true when asset with given ID exists in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AssetExists</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	assetJSON, err := ctx.GetStub().GetState(id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;failed to read from world state: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assetJSON != <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAssetByID 根据资产ID转账</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAssetByID</span><span class="params">(ctx contractapi.TransactionContextInterface, id <span class="keyword">string</span>, newID <span class="keyword">string</span>, newOwner <span class="keyword">string</span>, amount <span class="keyword">int64</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, id)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s.TransferAsset(ctx, asset, newID, newOwner, amount, contractHash, invoiceHash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAsset updates the owner field of asset with given id in world state.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset, newID <span class="keyword">string</span>, newOwner <span class="keyword">string</span>, amount <span class="keyword">int64</span>, contractHash <span class="keyword">string</span>, invoiceHash <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 如果金额刚好等于凭证资产的金额，直接更新凭证资产的拥有者</span></span><br><span class="line">	<span class="keyword">if</span> asset.Amount == amount &#123;</span><br><span class="line">		asset.Owner = newOwner</span><br><span class="line">		<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &gt; amount &#123; <span class="comment">// 如果凭证资产的金额大于转账的金额，则创建一个新的资产</span></span><br><span class="line">		<span class="keyword">if</span> newID == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;转账金额小于资产的金额时，newID必须不能为空&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 创建新的资产并保存</span></span><br><span class="line">		err := s.CreateAssetAndSave(ctx, newID, amount, asset.Issuer, newOwner, contractHash, invoiceHash)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 更新旧资产的金额</span></span><br><span class="line">		asset.Amount = asset.Amount - amount</span><br><span class="line">		<span class="keyword">return</span> s.PutState(ctx, asset)</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> asset.Amount &lt; amount &#123; <span class="comment">// 如果资产的额度小于要转账的金额，则直接报错</span></span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;转账金额=%d,不能超过资产的金额=%d&quot;</span>, amount, asset.Amount)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PutState 更新资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">PutState</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	assetJSON, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().PutState(asset.ID, assetJSON)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAllAssets returns all assets found in world state</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetAllAssets</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">([]*Asset, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// range query with empty string for startKey and endKey does an</span></span><br><span class="line">	<span class="comment">// open-ended query of all assets in the chaincode namespace.</span></span><br><span class="line">	resultsIterator, err := ctx.GetStub().GetStateByRange(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> resultsIterator.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> assets []*Asset</span><br><span class="line">	<span class="keyword">for</span> resultsIterator.HasNext() &#123;</span><br><span class="line">		queryResponse, err := resultsIterator.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> asset Asset</span><br><span class="line">		err = json.Unmarshal(queryResponse.Value, &amp;asset)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		assets = <span class="built_in">append</span>(assets, &amp;asset)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> assets, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="打包-v7">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.8.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_8.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v7">安装链码包</h3>
<p>每个peer都要安装：<code>peer lifecycle chaincode install supply.8.tar.gz</code></p>
<h3 id="批准链码定义-v13">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v7">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_8.0:797ec1d00145482b746640d0b8bb9bea64cb69dea3e95abb69a1195a19e34511</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v14">批准链码定义</h4>
<p>每个peer都要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 8.0 --package-id $CC_PACKAGE_ID --sequence 2 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v7">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID alljoinchannel --name supply --version 8.0 --sequence 2 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在所有组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 8.0 --sequence 2 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID alljoinchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v7">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9  CORE_AND_F1_INVOICE.txt</span><br><span class="line">93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14  CORE_AND_F1_CONTRACT.txt</span><br><span class="line">76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a  f1_and_s1_contract.txt</span><br><span class="line">792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49  f1_and_s1_invoice.txt</span><br><span class="line">f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb  f1_and_s2_contract.txt</span><br><span class="line">f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468  f1_and_s2_invoice.txt</span><br></pre></td></tr></table></figure>
<h4 id="发行凭证-v3">发行凭证</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;IssueVoucher&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;1000&quot;, &quot;一级供应商&quot;, &quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;, &quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="查询资产-v3">查询资产</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C alljoinchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">1000</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="一级供应商与二级供应商1交易-v2">一级供应商与二级供应商1交易</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;asset0011&quot;, &quot;二级供应商1&quot;, &quot;500&quot;, &quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;, &quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="查询资产-v4">查询资产</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C alljoinchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0011&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="一级供应商与二级供应商2交易-v3">一级供应商与二级供应商2交易</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;asset0012&quot;, &quot;二级供应商2&quot;, &quot;300&quot;, &quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;, &quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>查询资产，结果如下<code>peer chaincode query -C alljoinchannel -n supply -c '&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;'</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;一级供应商&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0011&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0012&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:58:33.143818Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:58:33.143818Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="转账金额大于凭证资产的金额-期待错误">转账金额大于凭证资产的金额(期待错误)</h3>
<p>出现错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) w:supply-finance apple$ peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;asset0013&quot;, &quot;二级供应商2&quot;, &quot;300&quot;, &quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;, &quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;]&#125;&#x27;</span><br><span class="line">Error: endorsement failure during invoke. response: status:500 message:&quot;\350\275\254\350\264\246\351\207\221\351\242\235=300,\344\270\215\350\203\275\350\266\205\350\277\207\350\265\204\344\272\247\347\232\204\351\207\221\351\242\235=200&quot;</span><br></pre></td></tr></table></figure>
<p>错误信息解码如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/guozhe001/oss/image-20201230151742496-20201230173424532.png" alt></p>
<h3 id="转账金额等于凭证资产的金额（变更owner，不产生新的凭证资产）">转账金额等于凭证资产的金额（变更owner，不产生新的凭证资产）</h3>
<p>一级供应商把剩余的200转给二级供应商2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;&#x2F;organizations&#x2F;ordererOrganizations&#x2F;supply.com&#x2F;orderers&#x2F;orderer.supply.com&#x2F;msp&#x2F;tlscacerts&#x2F;tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;&#x2F;organizations&#x2F;peerOrganizations&#x2F;f1.supply.com&#x2F;peers&#x2F;peer0.f1.supply.com&#x2F;tls&#x2F;ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;&#x2F;organizations&#x2F;peerOrganizations&#x2F;s1.supply.com&#x2F;peers&#x2F;peer0.s1.supply.com&#x2F;tls&#x2F;ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;&#x2F;organizations&#x2F;peerOrganizations&#x2F;s2.supply.com&#x2F;peers&#x2F;peer0.s2.supply.com&#x2F;tls&#x2F;ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;&#x2F;organizations&#x2F;peerOrganizations&#x2F;core.supply.com&#x2F;peers&#x2F;peer0.core.supply.com&#x2F;tls&#x2F;ca.crt -c &#39;&#123;&quot;function&quot;:&quot;TransferAssetByID&quot;,&quot;Args&quot;:[&quot;asset001&quot;, &quot;asset0013&quot;, &quot;二级供应商2&quot;, &quot;200&quot;, &quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;, &quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;]&#125;&#39;</span><br></pre></td></tr></table></figure>
<p>查询资产，结果如下<code>peer chaincode query -C alljoinchannel -n supply -c '&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;'</code>：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset001&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:06.963617Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0011&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">500</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:57:50.047189Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ID&quot;</span>: <span class="string">&quot;asset0012&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;issuer&quot;</span>: <span class="string">&quot;核心企业&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;owner&quot;</span>: <span class="string">&quot;二级供应商2&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;amount&quot;</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="attr">&quot;createDate&quot;</span>: <span class="string">&quot;2020-12-30T06:58:33.143818Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;endDate&quot;</span>: <span class="string">&quot;2021-06-30T06:58:33.143818Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;contractHash&quot;</span>: <span class="string">&quot;f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;invoiceHash&quot;</span>: <span class="string">&quot;f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>没有产生新的资产，而是把原来的资产的拥有者变更了。</p>
<p><em>注意：这样有个问题，合同hash和发票hash不应该还是原来的。</em></p>
<h2 id="部署supply-v9到alljoinchannel通道">部署supply-v9到alljoinchannel通道</h2>
<h3 id="源码-v2">源码</h3>
<p>与v8版本相比，增加删除资产的方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DelState 删除资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">DelState</span><span class="params">(ctx contractapi.TransactionContextInterface, assetIds ...<span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, assetID := <span class="keyword">range</span> assetIds &#123;</span><br><span class="line">		exists, err := s.AssetExists(ctx, assetID)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !exists &#123;</span><br><span class="line">			<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;assetID=%s的资产不存在&quot;</span>, assetID)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ctx.GetStub().DelState(assetID)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="打包-v8">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.18.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance-chaincode/ --lang golang --label secured_supply_22.0</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v8">安装链码包</h3>
<p>每个peer都要安装：<code>peer lifecycle chaincode install supply.18.tar.gz</code></p>
<h3 id="批准链码定义-v15">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v8">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=secured_supply_22.0:e815ca2d270dea029bc6992952140b1288a440aba8c430853f72eee7d5de24a7</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v16">批准链码定义</h4>
<p>每个peer都要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name secured_supply --version 22.0 --package-id $CC_PACKAGE_ID --sequence 22 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v8">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID alljoinchannel --name secured_supply --version 22.0 --sequence 22 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在所有组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name secured_supply --version 22.0 --sequence 22 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID alljoinchannel --name secured_supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v8">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9  CORE_AND_F1_INVOICE.txt</span><br><span class="line">93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14  CORE_AND_F1_CONTRACT.txt</span><br><span class="line">76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a  f1_and_s1_contract.txt</span><br><span class="line">792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49  f1_and_s1_invoice.txt</span><br><span class="line">f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb  f1_and_s2_contract.txt</span><br><span class="line">f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468  f1_and_s2_invoice.txt</span><br></pre></td></tr></table></figure>
<h4 id="删除资产">删除资产</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;DelState&quot;,&quot;Args&quot;:[&quot;asset001 asset0011 asset0012 asset003 asset0031 asset00311&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>错误信息记录：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(base) w:supply-finance apple$ peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;DelState&quot;,&quot;Args&quot;:[&quot;asset001 asset0011 asset0012 asset003 asset0031 asset00311&quot;]&#125;&#x27;</span><br><span class="line">Error: endorsement failure during invoke. response: status:500 message:&quot;Error managing parameter param0. Conversion error. Value asset001 asset0011 asset0012 asset003 asset0031 asset00311 was not passed in expected format []string&quot;</span><br></pre></td></tr></table></figure>
<p>**错误原因：**因为方法使用的是可变长参数，但是不知道该怎么给他传参数</p>
<h2 id="部署supply-v9-1到alljoinchannel通道">部署supply-v9.1到alljoinchannel通道</h2>
<h3 id="源码-v3">源码</h3>
<p>与v9版本相比，修改删除资产的方法为删除单个资产</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DelState 删除资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">DelState</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	exists, err := s.AssetExists(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> !exists &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;assetID=%s的资产不存在&quot;</span>, assetID)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().DelState(assetID)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="打包-v9">打包</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode package supply.9.1.tar.gz --path /Users/apple/code/open-source/blockchain/hyperledger/supply-finance/chaincode-go/ --lang golang --label supply_9.1</span><br></pre></td></tr></table></figure>
<h3 id="安装链码包-v9">安装链码包</h3>
<p>每个peer都要安装：<code>peer lifecycle chaincode install supply.9.1.tar.gz</code></p>
<h3 id="批准链码定义-v17">批准链码定义</h3>
<h4 id="查看已经安装的chaincode-v9">查看已经安装的chaincode</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode queryinstalled</span><br></pre></td></tr></table></figure>
<p>将链码的信息保存为一个变量，两个组织都需要定义此变量：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export CC_PACKAGE_ID=supply_9.1:f733e8484c17cb415e38ac1fb14ed646622f2980762906c97d6e7e1c1a90f2c3</span><br></pre></td></tr></table></figure>
<h4 id="批准链码定义-v18">批准链码定义</h4>
<p>每个peer都要执行此命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode approveformyorg -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 9.1 --package-id $CC_PACKAGE_ID --sequence 4 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="将链码定义提交到通道-v9">将链码定义提交到通道</h3>
<p>检查channel上的成员是否已经批准了链码定义：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode checkcommitreadiness --channelID alljoinchannel --name supply --version 9.1 --sequence 4 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --output json</span><br></pre></td></tr></table></figure>
<p>在所有组织都批准之后，执行下面的命令将链码定义提交到通道：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode commit -o localhost:8050  --ordererTLSHostnameOverride orderer.supply.com --channelID alljoinchannel --name supply --version 9.1 --sequence 4 --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt</span><br></pre></td></tr></table></figure>
<p>使用 <a target="_blank" rel="noopener" href="https://hyperledger-fabric.readthedocs.io/en/release-2.2/commands/peerlifecycle.html#peer-lifecycle-chaincode-querycommitted">peer lifecycle chaincode querycommitted</a> 命令来确认链码定义已经提交到通道。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer lifecycle chaincode querycommitted --channelID alljoinchannel --name supply --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem</span><br></pre></td></tr></table></figure>
<h3 id="调用链码-v9">调用链码</h3>
<p>调用链码之前先生成测试的合同hash值和发票hash值如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">83c02ac2d48c863dab2ccf6870455aadfc2cec073b8db269b517c879d76aa6d9  CORE_AND_F1_INVOICE.txt</span><br><span class="line">93b46869be90a6b1f688357965f89b5a8a5e32bf13710fb4ad00e25cca0f0b14  CORE_AND_F1_CONTRACT.txt</span><br><span class="line">76307cd9d79c76a2a7894677692ce421ff1a31e32717a7de6f07deb5de395e7a  f1_and_s1_contract.txt</span><br><span class="line">792376c209f338959be4cf00c54dbf82662b90516082e23106faec4c43c69e49  f1_and_s1_invoice.txt</span><br><span class="line">f46555b7ddd1f8dd232bdc0dcbc5b1f34bdf1d4bb7c123a79a6ed628175f29bb  f1_and_s2_contract.txt</span><br><span class="line">f807fe6dc767be2e7021d41540114b33b30fa7784f6de5521251f23a3eb66468  f1_and_s2_invoice.txt</span><br></pre></td></tr></table></figure>
<h4 id="删除资产-v2">删除资产</h4>
<p>资产ID列表：“asset001 asset0011 asset0012 asset003 asset0031 asset00311”</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;DelState&quot;,&quot;Args&quot;:[&quot;asset00311&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h4 id="删除之后查询：">删除之后查询：</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode query -C alljoinchannel -n supply -c &#x27;&#123;&quot;Args&quot;:[&quot;GetAllAssets&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>返回的资产列表为空，删除方法验证成功。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n secured_supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;Practice_SmartContract:InitLedger&quot;,&quot;Args&quot;:[]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n secured_supply --peerAddresses localhost:8053 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/f1.supply.com/peers/peer0.f1.supply.com/tls/ca.crt --peerAddresses localhost:8055 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s1.supply.com/peers/peer0.s1.supply.com/tls/ca.crt --peerAddresses localhost:8151 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/s2.supply.com/peers/peer0.s2.supply.com/tls/ca.crt --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;Practice_SmartContract:SomeStubMethod&quot;,&quot;Args&quot;:[&quot;asset1&quot;]&#125;&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">peer chaincode invoke -o localhost:8050 --ordererTLSHostnameOverride orderer.supply.com --tls --cafile $&#123;PWD&#125;/organizations/ordererOrganizations/supply.com/orderers/orderer.supply.com/msp/tlscacerts/tlsca.supply.com-cert.pem -C alljoinchannel -n secured_supply --peerAddresses localhost:8051 --tlsRootCertFiles $&#123;PWD&#125;/organizations/peerOrganizations/core.supply.com/peers/peer0.core.supply.com/tls/ca.crt -c &#x27;&#123;&quot;function&quot;:&quot;Practice_SmartContract:InitLedger&quot;,&quot;Args&quot;:[]&#125;&#x27;</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%96%B0%E7%9A%84%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel"><span class="toc-number">1.</span> <span class="toc-text">部署新的智能合约到channel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2V1%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.</span> <span class="toc-text">部署V1版本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85"><span class="toc-number">1.1.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85"><span class="toc-number">1.1.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v2"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93"><span class="toc-number">1.1.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81"><span class="toc-number">1.1.5.</span> <span class="toc-text">调用链码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6"><span class="toc-number">1.2.</span> <span class="toc-text">更新智能合约</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v2"><span class="toc-number">1.2.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v2"><span class="toc-number">1.2.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v3"><span class="toc-number">1.2.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v2"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v4"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v2"><span class="toc-number">1.2.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v2"><span class="toc-number">1.2.5.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E4%BA%A4%E6%98%93%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.6.</span> <span class="toc-text">调用交易方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">问题记录：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2v6%E7%89%88%E6%9C%AC%E7%9A%84supply"><span class="toc-number">1.4.</span> <span class="toc-text">部署v6版本的supply</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v6%E7%89%88%E6%9C%AC%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.4.1.</span> <span class="toc-text">v6版本智能合约源码如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v3"><span class="toc-number">1.4.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v3"><span class="toc-number">1.4.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v5"><span class="toc-number">1.4.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v3"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v6"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v3"><span class="toc-number">1.4.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v3"><span class="toc-number">1.4.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C-v2"><span class="toc-number">1.4.6.1.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E4%BA%A4%E6%98%93%E6%96%B9%E6%B3%95-v2"><span class="toc-number">1.4.7.</span> <span class="toc-text">调用交易方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2v7%E7%89%88%E6%9C%AC%E7%9A%84supply"><span class="toc-number">1.5.</span> <span class="toc-text">部署v7版本的supply</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#v7%E7%89%88%E6%9C%AC%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E6%BA%90%E7%A0%81%E5%A6%82%E4%B8%8B%EF%BC%9A"><span class="toc-number">1.5.1.</span> <span class="toc-text">v7版本智能合约源码如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v4"><span class="toc-number">1.5.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v4"><span class="toc-number">1.5.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v7"><span class="toc-number">1.5.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v4"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v8"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v4"><span class="toc-number">1.5.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v4"><span class="toc-number">1.5.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81"><span class="toc-number">1.5.6.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B0%83%E7%94%A8%E5%90%8E%E7%9A%84%E7%BB%93%E6%9E%9C-v3"><span class="toc-number">1.5.6.2.</span> <span class="toc-text">查询调用后的结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B9%8B%E9%97%B4%E7%9A%84channel"><span class="toc-number">1.6.</span> <span class="toc-text">创建一级供应商与二级供应商之间的channel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%80%9A%E9%81%93%EF%BC%9A"><span class="toc-number">1.6.1.</span> <span class="toc-text">创建通道：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E5%92%8C%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.</span> <span class="toc-text">把一级供应商和二级供应商的peer加入通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.1.</span> <span class="toc-text">一级供应商的peer加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF%E7%A1%AE%E8%AE%A4%E5%8A%A0%E5%85%A5%E6%88%90%E5%8A%9F"><span class="toc-number">1.7.2.</span> <span class="toc-text">通过获取通道信息确认加入成功</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.2.1.</span> <span class="toc-text">获取通道信息</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.3.</span> <span class="toc-text">二级供应商1加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E5%8A%A0%E5%85%A5%E9%80%9A%E9%81%93"><span class="toc-number">1.7.4.</span> <span class="toc-text">二级供应商2加入通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.</span> <span class="toc-text">设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BAGylFOrg1MSP%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.1.</span> <span class="toc-text">为GylFOrg1MSP设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84channel%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97"><span class="toc-number">1.7.5.1.1.</span> <span class="toc-text">拉取最新的channel配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97"><span class="toc-number">1.7.5.1.2.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A"><span class="toc-number">1.7.5.1.3.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D"><span class="toc-number">1.7.5.1.4.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF-peer-channel-getinfo-c-firstandsecondchannel"><span class="toc-number">1.7.5.1.5.</span> <span class="toc-text">验证，获取通道信息:peer channel getinfo -c firstandsecondchannel</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%EF%BC%88GylSOrg1MSP%EF%BC%89%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.2.</span> <span class="toc-text">为二级供应商1（GylSOrg1MSP）设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97-v2"><span class="toc-number">1.7.5.2.1.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A-v2"><span class="toc-number">1.7.5.2.2.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D-v2"><span class="toc-number">1.7.5.2.3.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF"><span class="toc-number">1.7.5.2.4.</span> <span class="toc-text">验证，获取通道信息</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%EF%BC%88GylSOrg2MSP%EF%BC%89%E8%AE%BE%E7%BD%AE%E9%94%9A%E8%8A%82%E7%82%B9"><span class="toc-number">1.7.5.3.</span> <span class="toc-text">为二级供应商2（GylSOrg2MSP）设置锚节点</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E5%8C%BA%E5%9D%97-v3"><span class="toc-number">1.7.5.3.1.</span> <span class="toc-text">修改通道配置区块</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E6%9B%B4%E6%96%B0%E5%90%8E%E7%9A%84%E4%BA%A4%E6%98%93%E6%89%93%E5%8C%85%E6%88%90%E4%B8%80%E4%B8%AA%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%EF%BC%9A-v3"><span class="toc-number">1.7.5.3.2.</span> <span class="toc-text">把更新后的交易打包成一个更新通道配置的交易：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8F%90%E4%BA%A4%E2%80%9C%E6%9B%B4%E6%96%B0%E9%80%9A%E9%81%93%E9%85%8D%E7%BD%AE%E7%9A%84%E4%BA%A4%E6%98%93%E2%80%9D-v3"><span class="toc-number">1.7.5.3.3.</span> <span class="toc-text">提交“更新通道配置的交易”</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%EF%BC%8C%E8%8E%B7%E5%8F%96%E9%80%9A%E9%81%93%E4%BF%A1%E6%81%AF-v2"><span class="toc-number">1.7.5.3.4.</span> <span class="toc-text">验证，获取通道信息</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v7%E5%88%B0%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E7%9A%84peer%E8%8A%82%E7%82%B9"><span class="toc-number">1.8.</span> <span class="toc-text">部署supply-v7到二级供应商的peer节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v5"><span class="toc-number">1.8.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v5"><span class="toc-number">1.8.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v9"><span class="toc-number">1.8.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v5"><span class="toc-number">1.8.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v10"><span class="toc-number">1.8.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v5"><span class="toc-number">1.8.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v5"><span class="toc-number">1.8.5.</span> <span class="toc-text">调用链码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BC%81%E4%B8%9A%E3%80%81%E4%B8%80%E7%BA%A7%E5%92%8C%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E5%8A%A0%E5%85%A5%E5%90%8C%E4%B8%80%E4%B8%AAchannel"><span class="toc-number">1.9.</span> <span class="toc-text">核心企业、一级和二级供应商加入同一个channel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v7%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.10.</span> <span class="toc-text">部署supply-v7到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v6"><span class="toc-number">1.10.1.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v6"><span class="toc-number">1.10.2.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v11"><span class="toc-number">1.10.3.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v6"><span class="toc-number">1.10.3.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v12"><span class="toc-number">1.10.3.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v6"><span class="toc-number">1.10.4.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v6"><span class="toc-number">1.10.5.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81-v2"><span class="toc-number">1.10.5.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7"><span class="toc-number">1.10.5.2.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E4%BA%A4%E6%98%93"><span class="toc-number">1.10.5.3.</span> <span class="toc-text">一级供应商与二级供应商1交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v2"><span class="toc-number">1.10.5.4.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93"><span class="toc-number">1.10.5.5.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93-v2"><span class="toc-number">1.10.5.6.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v8%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.11.</span> <span class="toc-text">部署supply-v8到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.11.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v7"><span class="toc-number">1.11.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v7"><span class="toc-number">1.11.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v13"><span class="toc-number">1.11.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v7"><span class="toc-number">1.11.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v14"><span class="toc-number">1.11.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v7"><span class="toc-number">1.11.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v7"><span class="toc-number">1.11.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%91%E8%A1%8C%E5%87%AD%E8%AF%81-v3"><span class="toc-number">1.11.6.1.</span> <span class="toc-text">发行凭证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v3"><span class="toc-number">1.11.6.2.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%861%E4%BA%A4%E6%98%93-v2"><span class="toc-number">1.11.6.3.</span> <span class="toc-text">一级供应商与二级供应商1交易</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E8%B5%84%E4%BA%A7-v4"><span class="toc-number">1.11.6.4.</span> <span class="toc-text">查询资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%86%E4%B8%8E%E4%BA%8C%E7%BA%A7%E4%BE%9B%E5%BA%94%E5%95%862%E4%BA%A4%E6%98%93-v3"><span class="toc-number">1.11.6.5.</span> <span class="toc-text">一级供应商与二级供应商2交易</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E9%87%91%E9%A2%9D%E5%A4%A7%E4%BA%8E%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%E7%9A%84%E9%87%91%E9%A2%9D-%E6%9C%9F%E5%BE%85%E9%94%99%E8%AF%AF"><span class="toc-number">1.11.7.</span> <span class="toc-text">转账金额大于凭证资产的金额(期待错误)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E8%B4%A6%E9%87%91%E9%A2%9D%E7%AD%89%E4%BA%8E%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%E7%9A%84%E9%87%91%E9%A2%9D%EF%BC%88%E5%8F%98%E6%9B%B4owner%EF%BC%8C%E4%B8%8D%E4%BA%A7%E7%94%9F%E6%96%B0%E7%9A%84%E5%87%AD%E8%AF%81%E8%B5%84%E4%BA%A7%EF%BC%89"><span class="toc-number">1.11.8.</span> <span class="toc-text">转账金额等于凭证资产的金额（变更owner，不产生新的凭证资产）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v9%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.12.</span> <span class="toc-text">部署supply-v9到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-v2"><span class="toc-number">1.12.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v8"><span class="toc-number">1.12.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v8"><span class="toc-number">1.12.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v15"><span class="toc-number">1.12.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v8"><span class="toc-number">1.12.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v16"><span class="toc-number">1.12.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v8"><span class="toc-number">1.12.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v8"><span class="toc-number">1.12.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%B5%84%E4%BA%A7"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">删除资产</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2supply-v9-1%E5%88%B0alljoinchannel%E9%80%9A%E9%81%93"><span class="toc-number">1.13.</span> <span class="toc-text">部署supply-v9.1到alljoinchannel通道</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81-v3"><span class="toc-number">1.13.1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%93%E5%8C%85-v9"><span class="toc-number">1.13.2.</span> <span class="toc-text">打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%93%BE%E7%A0%81%E5%8C%85-v9"><span class="toc-number">1.13.3.</span> <span class="toc-text">安装链码包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v17"><span class="toc-number">1.13.4.</span> <span class="toc-text">批准链码定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%B7%B2%E7%BB%8F%E5%AE%89%E8%A3%85%E7%9A%84chaincode-v9"><span class="toc-number">1.13.4.1.</span> <span class="toc-text">查看已经安装的chaincode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%89%B9%E5%87%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89-v18"><span class="toc-number">1.13.4.2.</span> <span class="toc-text">批准链码定义</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%93%BE%E7%A0%81%E5%AE%9A%E4%B9%89%E6%8F%90%E4%BA%A4%E5%88%B0%E9%80%9A%E9%81%93-v9"><span class="toc-number">1.13.5.</span> <span class="toc-text">将链码定义提交到通道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE%E7%A0%81-v9"><span class="toc-number">1.13.6.</span> <span class="toc-text">调用链码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E8%B5%84%E4%BA%A7-v2"><span class="toc-number">1.13.6.1.</span> <span class="toc-text">删除资产</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E4%B9%8B%E5%90%8E%E6%9F%A5%E8%AF%A2%EF%BC%9A"><span class="toc-number">1.13.6.2.</span> <span class="toc-text">删除之后查询：</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&text=部署新的智能合约到channel"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&is_video=false&description=部署新的智能合约到channel"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=部署新的智能合约到channel&body=Check out this article: https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&title=部署新的智能合约到channel"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&name=部署新的智能合约到channel&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E9%80%9A%E8%BF%87%E4%BE%9B%E5%BA%94%E9%93%BE%E9%87%91%E8%9E%8D%E7%BB%83%E4%B9%A0Fabric/%E9%83%A8%E7%BD%B2%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E5%88%B0channel/&t=部署新的智能合约到channel"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    guozhe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
