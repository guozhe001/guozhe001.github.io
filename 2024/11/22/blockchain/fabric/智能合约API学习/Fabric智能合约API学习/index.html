<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="这篇文档通过学习之前写的chaincode来查看Fabric的智能合约相关的源码。并学习这些源码的功能。 智能合约里面的方法如何定义的 智能合约中的每个导出的方法都必须有contractapi.TransactionContextInterface类型的参数，并且这个方法是被定义在SmartContract上的，如下面一个获取资产出价价格的方法。 1234&#x2F;&#x2F; GetAssetBidPrice r">
<meta property="og:type" content="article">
<meta property="og:title" content="Fabric智能合约API学习">
<meta property="og:url" content="https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="滴水成涓">
<meta property="og:description" content="这篇文档通过学习之前写的chaincode来查看Fabric的智能合约相关的源码。并学习这些源码的功能。 智能合约里面的方法如何定义的 智能合约中的每个导出的方法都必须有contractapi.TransactionContextInterface类型的参数，并且这个方法是被定义在SmartContract上的，如下面一个获取资产出价价格的方法。 1234&#x2F;&#x2F; GetAssetBidPrice r">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-11-22T06:32:06.495Z">
<meta property="article:modified_time" content="2024-11-22T06:32:06.495Z">
<meta property="article:author" content="guozhe">
<meta property="article:tag" content="blockchain">
<meta property="article:tag" content="Hyperledger-Fabric">
<meta property="article:tag" content="API">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Fabric智能合约API学习</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="滴水成涓" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/ClientIdentity%E6%8E%A5%E5%8F%A3%E7%BB%83%E4%B9%A0/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/contract_chaincode.go%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&text=Fabric智能合约API学习"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&is_video=false&description=Fabric智能合约API学习"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Fabric智能合约API学习&body=Check out this article: https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&name=Fabric智能合约API学习&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&t=Fabric智能合约API学习"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8C%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text">智能合约里面的方法如何定义的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mock%E6%96%B9%E5%BC%8F%E6%B5%8B%E8%AF%95shim-ChaincodeStubInterface%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">mock方式测试shim.ChaincodeStubInterface中的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%97%A0%E6%B3%95mock%E6%B5%8B%E8%AF%95%E7%9A%84shim-ChaincodeStubInterface%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">测试无法mock测试的shim.ChaincodeStubInterface方法</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Fabric智能合约API学习
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">guozhe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-22T06:32:06.495Z" itemprop="datePublished">2024-11-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/">blockchain</a> › <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/Hyperledger-Fabric/">Hyperledger-Fabric</a> › <a class="category-link" href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/Hyperledger-Fabric/chaincode-API/">chaincode-API</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/API/" rel="tag">API</a>, <a class="tag-link-link" href="/tags/Hyperledger-Fabric/" rel="tag">Hyperledger-Fabric</a>, <a class="tag-link-link" href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/" rel="tag">blockchain</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>这篇文档通过学习之前写的chaincode来查看Fabric的智能合约相关的源码。并学习这些源码的功能。</p>
<h2 id="智能合约里面的方法如何定义的">智能合约里面的方法如何定义的</h2>
<p>智能合约中的每个导出的方法都必须有<code>contractapi.TransactionContextInterface</code>类型的参数，并且这个方法是被定义在<code>SmartContract</code>上的，如下面一个获取资产出价价格的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GetAssetBidPrice returns the bid price</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetAssetBidPrice</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> getAssetPrice(ctx, assetID, typeAssetBid)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>contractapi.TransactionContextInterface</code>的源码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TransactionContextInterface defines the interface which TransactionContext</span></span><br><span class="line"><span class="comment">// meets. This can be taken by transacton functions on a contract which has not set</span></span><br><span class="line"><span class="comment">// a custom transaction context to allow transaction functions to take an interface</span></span><br><span class="line"><span class="comment">// to simplify unit testing.</span></span><br><span class="line"><span class="comment">// 交易上下文接口，为了方便测试</span></span><br><span class="line"><span class="keyword">type</span> TransactionContextInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// GetStub should provide a way to access the stub set by Init/Invoke</span></span><br><span class="line">  <span class="comment">// 获取由Init/Invoke设置的存根</span></span><br><span class="line">	GetStub() shim.ChaincodeStubInterface</span><br><span class="line">	<span class="comment">// GetClientIdentity should provide a way to access the client identity set by Init/Invoke</span></span><br><span class="line">  <span class="comment">// 获取由Init/Invoke设置的客户端身份</span></span><br><span class="line">	GetClientIdentity() cid.ClientIdentity</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="mock方式测试shim-ChaincodeStubInterface中的方法">mock方式测试<code>shim.ChaincodeStubInterface</code>中的方法</h3>
<p>接着看<code>shim.ChaincodeStubInterface</code>有哪些功能，源码在这里就不贴了，直接看测试用例,下面的测试用例的入口是<code>TestStart</code>，不包含尚未实现mock的方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> chaincode_test</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-chaincode-go/pkg/statebased&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-contract-api-go/contractapi&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;testing&quot;</span></span><br><span class="line">	<span class="string">&quot;unsafe&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/guozhe001/learn-contractapi-go/chaincode&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-chaincode-go/shim&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-chaincode-go/shimtest&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/stretchr/testify/require&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mockInitLedger</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	assets := []chaincode.Asset&#123;</span><br><span class="line">		&#123;ID: AssetId, Color: <span class="string">&quot;blue&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Tomoko&quot;</span>, AppraisedValue: <span class="number">300</span>&#125;,</span><br><span class="line">		&#123;ID: <span class="string">&quot;asset2&quot;</span>, Color: <span class="string">&quot;red&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Brad&quot;</span>, AppraisedValue: <span class="number">400</span>&#125;,</span><br><span class="line">		&#123;ID: <span class="string">&quot;asset3&quot;</span>, Color: <span class="string">&quot;green&quot;</span>, Size: <span class="number">10</span>, Owner: <span class="string">&quot;Jin Soo&quot;</span>, AppraisedValue: <span class="number">500</span>&#125;,</span><br><span class="line">		&#123;ID: <span class="string">&quot;asset4&quot;</span>, Color: <span class="string">&quot;yellow&quot;</span>, Size: <span class="number">10</span>, Owner: <span class="string">&quot;Max&quot;</span>, AppraisedValue: <span class="number">600</span>&#125;,</span><br><span class="line">		&#123;ID: <span class="string">&quot;asset5&quot;</span>, Color: <span class="string">&quot;black&quot;</span>, Size: <span class="number">15</span>, Owner: <span class="string">&quot;Adriana&quot;</span>, AppraisedValue: <span class="number">700</span>&#125;,</span><br><span class="line">		&#123;ID: <span class="string">&quot;asset6&quot;</span>, Color: <span class="string">&quot;white&quot;</span>, Size: <span class="number">15</span>, Owner: <span class="string">&quot;Michel&quot;</span>, AppraisedValue: <span class="number">800</span>&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">	stub.MockTransactionStart(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">	putState(t, stub, assets...)</span><br><span class="line">	id := stub.GetTxID()</span><br><span class="line">	timestamp, err := stub.GetTxTimestamp()</span><br><span class="line">	channelID := stub.GetChannelID()</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NotNil(t, timestamp)</span><br><span class="line">	log.Printf(<span class="string">&quot;GetTxID()=%s, GetTxTimestamp()=%s, GetChannelID()=%s&quot;</span>, id, timestamp, channelID)</span><br><span class="line">	stub.MockTransactionEnd(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">marshal</span><span class="params">(asset chaincode.Asset, t *testing.T)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	assetJSON, err := json.Marshal(asset)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="keyword">return</span> assetJSON</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#PutState()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">putState</span><span class="params">(t *testing.T, stub *shimtest.MockStub, assets ...chaincode.Asset)</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, asset := <span class="keyword">range</span> assets &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;putState=%v&quot;</span>, asset)</span><br><span class="line">		require.NoError(t, stub.PutState(asset.ID, marshal(asset, t)))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetState()</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#PutState()</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#DelState()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getState</span><span class="params">(assetId <span class="keyword">string</span>, t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取指定key的资产的世界状态</span></span><br><span class="line">	state, err := stub.GetState(assetId)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	printAsset(t, state)</span><br><span class="line">	newAssetID := <span class="string">&quot;temp001&quot;</span></span><br><span class="line">	newAsset := chaincode.Asset&#123;ID: newAssetID, Color: <span class="string">&quot;blue&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Tomoko&quot;</span>, AppraisedValue: <span class="number">300</span>&#125;</span><br><span class="line">	<span class="comment">// put一个新的资产</span></span><br><span class="line">	putState(t, stub, newAsset)</span><br><span class="line">	<span class="comment">// 查询新的资产</span></span><br><span class="line">	newState, err := stub.GetState(newAssetID)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NotNil(t, newState)</span><br><span class="line">	printAsset(t, newState)</span><br><span class="line">	<span class="comment">// 指定资产ID删除资产</span></span><br><span class="line">	require.NoError(t, stub.DelState(newAssetID))</span><br><span class="line">	<span class="comment">// 删除之后重新查询新的资产</span></span><br><span class="line">	newStateAgain, err := stub.GetState(newAssetID)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.Nil(t, newStateAgain)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getHistoryForKey</span><span class="params">(assetId <span class="keyword">string</span>, t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取key的历史数据，目前mock还未实现</span></span><br><span class="line">	history, err := stub.GetHistoryForKey(assetId)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="keyword">if</span> history != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> history.HasNext() &#123;</span><br><span class="line">			next, err := history.Next()</span><br><span class="line">			require.NoError(t, err)</span><br><span class="line">			marshal, err := json.Marshal(next)</span><br><span class="line">			require.NoError(t, err)</span><br><span class="line">			log.Printf(<span class="string">&quot;asset=%s history=%s&quot;</span>, assetId, marshal)</span><br><span class="line">		&#125;</span><br><span class="line">		history.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printAsset</span><span class="params">(t *testing.T, state []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> a chaincode.Asset</span><br><span class="line">	require.NoError(t, json.Unmarshal(state, &amp;a))</span><br><span class="line">	marshal, err := json.Marshal(a)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	log.Printf(<span class="string">&quot;result state json value = %s&quot;</span>, marshal)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetArgs()</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetStringArgs()</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getArgs</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	args := stub.GetArgs()</span><br><span class="line">	<span class="keyword">for</span> _, arg := <span class="keyword">range</span> args &#123;</span><br><span class="line">		log.Print(<span class="keyword">string</span>(arg))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	stringArgs := stub.GetStringArgs()</span><br><span class="line">	<span class="keyword">for</span> _, argString := <span class="keyword">range</span> stringArgs &#123;</span><br><span class="line">		log.Print(argString)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetStateByRange(startKey, endKey string) (StateQueryIteratorInterface, error)</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetStateByRangeWithPagination(startKey, endKey string, pageSize int32, bookmark string) (StateQueryIteratorInterface, *pb.QueryResponseMetadata, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getStateByRange</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	<span class="comment">// GetStateByRange不指定startKey和endKey，会返回全部的资产；谨慎使用</span></span><br><span class="line">	states, err := stub.GetStateByRange(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	printStateQueryIteratorInterface(t, states)</span><br><span class="line">	<span class="comment">// GetStateByRangeWithPagination 因为mockStub直接返回三个nil，所以无法在mock环境测试</span></span><br><span class="line">	pagination, metadata, err := stub.GetStateByRangeWithPagination(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">5</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	log.Print(<span class="string">&quot;==========================================================================================&quot;</span>)</span><br><span class="line">	log.Printf(<span class="string">&quot;GetStateByRangeWithPagination metadata=%v&quot;</span>, metadata)</span><br><span class="line">	printStateQueryIteratorInterface(t, pagination)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printStateQueryIteratorInterface</span><span class="params">(t *testing.T, states shim.StateQueryIteratorInterface)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> states != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> states.HasNext() &#123;</span><br><span class="line">			next, err := states.Next()</span><br><span class="line">			require.NoError(t, err)</span><br><span class="line">			log.Print(next)</span><br><span class="line">		&#125;</span><br><span class="line">		states.Close()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#CreateCompositeKey(objectType string, attributes []string) (string, error)</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#SplitCompositeKey(compositeKey string) (string, []string, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createCompositeKey</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	objectType := <span class="string">&quot;test&quot;</span></span><br><span class="line">	attributes := []<span class="keyword">string</span>&#123;<span class="string">&quot;param1&quot;</span>, <span class="string">&quot;param2&quot;</span>, <span class="string">&quot;param3&quot;</span>, <span class="string">&quot;end&quot;</span>&#125;</span><br><span class="line">	<span class="comment">// 创建组合key，拼接了一下</span></span><br><span class="line">	key, err := stub.CreateCompositeKey(objectType, attributes)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	log.Printf(<span class="string">&quot;key=%s&quot;</span>, key)</span><br><span class="line">	<span class="comment">// 分割组合key，CreateCompositeKey的逆运算</span></span><br><span class="line">	compositeKey, strings, err := stub.SplitCompositeKey(key)</span><br><span class="line">	require.Equal(t, objectType, compositeKey)</span><br><span class="line">	require.Equal(t, attributes, strings)</span><br><span class="line">	newAsset := chaincode.Asset&#123;ID: key, Color: <span class="string">&quot;blue&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Tomoko&quot;</span>, AppraisedValue: <span class="number">300</span>&#125;</span><br><span class="line">	putState(t, stub, newAsset)</span><br><span class="line">	empty := []<span class="keyword">string</span>&#123;&#125;</span><br><span class="line">	<span class="comment">// 根据创建组合key的参数查询，后面的参数可以是空，这样会全部匹配出来</span></span><br><span class="line">	states, err := stub.GetStateByPartialCompositeKey(objectType, empty)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NotNil(t, states)</span><br><span class="line">	printStateQueryIteratorInterface(t, states)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	AssetId        <span class="keyword">string</span> = <span class="string">&quot;asset1&quot;</span></span><br><span class="line">	TestMSP        <span class="keyword">string</span> = <span class="string">&quot;TestMSP&quot;</span></span><br><span class="line">	TestCollection <span class="keyword">string</span> = <span class="string">&quot;private_TestMSP&quot;</span></span><br><span class="line">	Blank          <span class="keyword">string</span> = <span class="string">&quot;&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#SetStateValidationParameter(key string, ep []byte) error</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetStateValidationParameter(key string) ([]byte, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setStateValidationParameter</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 新建一个基于状态的背书策略</span></span><br><span class="line">	endorsementPolicy, err := statebased.NewStateEP(<span class="literal">nil</span>)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="comment">// 向背书策略添加需要背书的公司</span></span><br><span class="line">	require.NoError(t, endorsementPolicy.AddOrgs(statebased.RoleTypeMember, TestMSP))</span><br><span class="line">	policy, err := endorsementPolicy.Policy()</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="comment">// SetStateValidationParameter设置基于状态的背书策略</span></span><br><span class="line">	require.NoError(t, stub.SetStateValidationParameter(AssetId, policy))</span><br><span class="line">	<span class="comment">// GetStateValidationParameter获取基于状态的背书策略</span></span><br><span class="line">	parameter, err := stub.GetStateValidationParameter(AssetId)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	str := byteToString(parameter)</span><br><span class="line">	<span class="comment">// 打印出来的StateValidationParameter有特殊字符，所以使用包含传入的字符的方式断言</span></span><br><span class="line">	log.Printf(<span class="string">&quot;ID=%s, StateValidationParameter=%s&quot;</span>, AssetId, str)</span><br><span class="line">	require.Contains(t, str, TestMSP)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetPrivateData(collection, key string) ([]byte, error)</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetPrivateDataHash(collection, key string) ([]byte, error) 获取私有数据的hash值，这个方法就算不是私有数据的所有者也可以调用，mock版本没有实现；</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#DelPrivateData(collection, key string) error 删除私有数据，mock版本没有实现；</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#SetPrivateDataValidationParameter(collection, key string, ep []byte) error 设置私有数据的</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetPrivateDataValidationParameter(collection, key string) ([]byte, error)</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetPrivateDataByRange(collection, startKey, endKey string) (StateQueryIteratorInterface, error) 根据范围查询私有数据</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetPrivateDataByPartialCompositeKey(collection, objectType string, keys []string) (StateQueryIteratorInterface, error)</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getPrivateData</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	key := <span class="string">&quot;private001&quot;</span></span><br><span class="line">	privateAsset := chaincode.Asset&#123;ID: key, Color: <span class="string">&quot;blue&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Tomoko&quot;</span>, AppraisedValue: <span class="number">300</span>&#125;</span><br><span class="line">	bytes, err := json.Marshal(privateAsset)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="comment">// 添加私有数据</span></span><br><span class="line">	require.NoError(t, stub.PutPrivateData(TestCollection, key, bytes))</span><br><span class="line">	<span class="comment">// 获取私有资产</span></span><br><span class="line">	data, err := stub.GetPrivateData(TestCollection, key)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NotNil(t, data)</span><br><span class="line">	printAsset(t, data)</span><br><span class="line">	<span class="comment">// 使用不存在的其他的collection获取私有资产，不会返回error，会返回nil数据</span></span><br><span class="line">	data, err = stub.GetPrivateData(<span class="string">&quot;test_collections&quot;</span>, key)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.Nil(t, data)</span><br><span class="line">	<span class="comment">// 使用其他的key获取不存在私有资产</span></span><br><span class="line">	data, err = stub.GetPrivateData(TestCollection, AssetId)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.Nil(t, data)</span><br><span class="line">	<span class="comment">// 查询公共资产数据,断言没有这个资产</span></span><br><span class="line">	state, err := stub.GetState(key)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.Nil(t, state)</span><br><span class="line"></span><br><span class="line">	endorsementPolicy, err := statebased.NewStateEP(<span class="literal">nil</span>)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NoError(t, endorsementPolicy.AddOrgs(statebased.RoleTypeMember, TestMSP))</span><br><span class="line">	policy, err := endorsementPolicy.Policy()</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NoError(t, stub.SetPrivateDataValidationParameter(TestCollection, key, policy))</span><br><span class="line">	parameter, err := stub.GetPrivateDataValidationParameter(TestCollection, key)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	str := byteToString(parameter)</span><br><span class="line">	<span class="comment">// 打印出来的StateValidationParameter有特殊字符，所以使用包含传入的字符的方式断言</span></span><br><span class="line">	log.Printf(<span class="string">&quot;ID=%s, StateValidationParameter=%s&quot;</span>, AssetId, str)</span><br><span class="line">	require.Contains(t, str, TestMSP)</span><br><span class="line">	<span class="comment">// GetPrivateDataHash(collection, key string) ([]byte, error) 获取私有数据的hash值，这个方法就算不是私有数据的所有者也可以调用，mock版本没有实现；</span></span><br><span class="line">	<span class="comment">// DelPrivateData(collection, key string) error 删除私有数据，mock版本没有实现；</span></span><br><span class="line">	<span class="comment">//require.NoError(t, stub.DelPrivateData(TestCollection, key))</span></span><br><span class="line">	<span class="comment">//// 删除之后再次查询，断言已经没有此资产</span></span><br><span class="line">	<span class="comment">//data, err = stub.GetPrivateData(TestCollection, key)</span></span><br><span class="line">	<span class="comment">//require.NoError(t, err)</span></span><br><span class="line">	<span class="comment">//require.Nil(t, state)</span></span><br><span class="line">	<span class="comment">// GetPrivateDataByRange没有实现</span></span><br><span class="line">	<span class="comment">//byRange, err := stub.GetPrivateDataByRange(TestCollection, Blank, Blank)</span></span><br><span class="line">	<span class="comment">//require.NoError(t, err)</span></span><br><span class="line">	<span class="comment">//require.NotNil(t, byRange)</span></span><br><span class="line">	<span class="comment">//for byRange.HasNext() &#123;</span></span><br><span class="line">	<span class="comment">//	next, err := byRange.Next()</span></span><br><span class="line">	<span class="comment">//	require.NotNil(t, err)</span></span><br><span class="line">	<span class="comment">//	log.Print(next)</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">byteToString</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	str := (*<span class="keyword">string</span>)(unsafe.Pointer(&amp;data))</span><br><span class="line">	<span class="keyword">return</span> *str</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#ChaincodeStubInterface#GetCreator() ([]byte, error) 获取签约交易提议的人，签约提议的人也是这个交易的创建者; mockstub未实现</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetTransient() (map[string][]byte, error) 获取临时数据，这个方法只有设置了临时数据的peer才能查到数据，主要是为了做隐私保护的，详情参考隐秘的交易资产</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetBinding() ([]byte, error) TODO 待理解</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetDecorations() ([]byte, error) TODO 待理解,目前看是为了传递更多关于提议的的额外数据</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#GetSignedProposal() ([]byte, error) 获取提议</span></span><br><span class="line"><span class="comment">// ChaincodeStubInterface#SetEvent(name string, payload []byte) error  允许链码在提议的response设置一个事件。无论交易的有效性如何，事件都将在已提交的块中的交易内可用。一个交易只能包含一个事件，并且如果是链码调用另一个链码的情况，事件只能在最外层。</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stubOthers</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	m := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]<span class="keyword">byte</span>)</span><br><span class="line">	tempAsset := chaincode.Asset&#123;ID: <span class="string">&quot;temp001&quot;</span>, Color: <span class="string">&quot;blue&quot;</span>, Size: <span class="number">5</span>, Owner: <span class="string">&quot;Tomoko&quot;</span>, AppraisedValue: <span class="number">300</span>&#125;</span><br><span class="line">	m[<span class="string">&quot;temp_asset&quot;</span>], _ = json.Marshal(tempAsset)</span><br><span class="line">	require.NoError(t, stub.SetTransient(m))</span><br><span class="line">	transient, err := stub.GetTransient()</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	require.NotNil(t, transient)</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> transient &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;k=%s, v=%s&quot;</span>, k, v)</span><br><span class="line">	&#125;</span><br><span class="line">	decorations := stub.GetDecorations()</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> decorations &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;k=%s, v=%s&quot;</span>, k, v)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试shim.ChaincodeStubInterface接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">stubTest</span><span class="params">(t *testing.T, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	assetId := AssetId</span><br><span class="line">	mockInitLedger(t, stub)</span><br><span class="line">	stub.MockTransactionStart(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">	getState(assetId, t, stub)</span><br><span class="line">	<span class="comment">//getHistoryForKey(assetId, t, stub)</span></span><br><span class="line">	getArgs(t, stub)</span><br><span class="line">	stub.MockTransactionStart(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">	getStateByRange(t, stub)</span><br><span class="line">	createCompositeKey(t, stub)</span><br><span class="line">	setStateValidationParameter(t, stub)</span><br><span class="line">	getPrivateData(t, stub)</span><br><span class="line">	stubOthers(t, stub)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试contractapi.Contract的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">contractTest</span><span class="params">(t *testing.T, ccc *contractapi.ContractChaincode, stub *shimtest.MockStub)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;DefaultContract=%s&quot;</span>, ccc.DefaultContract)</span><br><span class="line">	info := ccc.Info</span><br><span class="line">	log.Printf(<span class="string">&quot;info=%v&quot;</span>, info)</span><br><span class="line">	stub.MockTransactionStart(<span class="string">&quot;contract_test&quot;</span>)</span><br><span class="line">	<span class="comment">// 如果调用一个不存在的方法，如果实现了GetUnknownTransaction接口，则会执行此接口返回的方法；否则不执行，并且也不会报错，但是如果有before方法是会执行的</span></span><br><span class="line">	response := stub.MockInvoke(<span class="string">&quot;uuid_002&quot;</span>, [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(<span class="string">&quot;Unknow&quot;</span>)&#125;)</span><br><span class="line">	log.Printf(<span class="string">&quot;response=%#v, response.Status=%d, response.Payload=%s&quot;</span>, response, response.Status, byteToString(response.Payload))</span><br><span class="line">	<span class="comment">// 调用一个被忽略的方法, 虽然IgnoredMe方法在智能合约中存在，但是因为合约满足IgnoreContractInterface接口然后把这个方法加入到了忽略列表中，所以最后还是调用的默认方法</span></span><br><span class="line">	response = stub.MockInvoke(<span class="string">&quot;uuid_002&quot;</span>, [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(<span class="string">&quot;IgnoredMe&quot;</span>)&#125;)</span><br><span class="line">	log.Printf(<span class="string">&quot;response=%#v, response.Status=%d, response.Payload=%s&quot;</span>, response, response.Status, byteToString(response.Payload))</span><br><span class="line">	<span class="comment">// 指定某个指定合约，调用一个不存在的方法，冒号前面的部分是智能合约名称，后面是方法名称</span></span><br><span class="line">	response = stub.MockInvoke(<span class="string">&quot;uuid_002&quot;</span>, [][]<span class="keyword">byte</span>&#123;[]<span class="keyword">byte</span>(<span class="string">&quot;TestSmartContract:Unknow&quot;</span>)&#125;)</span><br><span class="line">	log.Printf(<span class="string">&quot;response=%#v, response.Status=%d, response.Payload=%s&quot;</span>, response, response.Status, byteToString(response.Payload))</span><br><span class="line">	<span class="comment">//invoke := ccc.Invoke(stub)</span></span><br><span class="line">	<span class="comment">//log.Printf(&quot;response=%v&quot;, invoke)</span></span><br><span class="line">	stub.MockTransactionEnd(<span class="string">&quot;uuid_001&quot;</span>)</span><br><span class="line">	transactionSerializer := ccc.TransactionSerializer</span><br><span class="line">	log.Printf(<span class="string">&quot;transactionSerializer=%v&quot;</span>, transactionSerializer)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试入口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestStart</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">	<span class="comment">// 一个链码包中可以有多个智能合约</span></span><br><span class="line">	assetChaincode, err := contractapi.NewChaincode(&amp;chaincode.SmartContract&#123;&#125;, &amp;TestSmartContract&#123;&#125;)</span><br><span class="line">	require.NoError(t, err)</span><br><span class="line">	<span class="comment">// NewMockStub</span></span><br><span class="line">	stub := shimtest.NewMockStub(<span class="string">&quot;mockSub&quot;</span>, assetChaincode)</span><br><span class="line">	stubTest(t, stub)</span><br><span class="line">	contractTest(t, assetChaincode, stub)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> TestSmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">	contractapi.Contract</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetUnknownTransaction returns the current set unknownTransaction, may be nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TestSmartContract)</span> <span class="title">GetUnknownTransaction</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> t.UnknownTransaction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default 如果不指定方法名称时指定的默认方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t *TestSmartContract)</span> <span class="title">UnknownTransaction</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;hello, i&#x27;m Default func in TestSmartContract！&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;i&#x27;m TestSmartContract, Bye!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在智能合约中添加了如下的一些方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// GetUnknownTransaction returns the current set unknownTransaction, may be nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetUnknownTransaction</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> s.UnknownTransaction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default 如果不指定方法名称时指定的默认方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">UnknownTransaction</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;hello, i&#x27;m Default func！&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="string">&quot;Bye!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetBeforeTransaction returns the current set beforeTransaction, may be nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetBeforeTransaction</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> s.BeforeTransaction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">BeforeTransaction</span><span class="params">(ctx contractapi.TransactionContextInterface)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;i&#x27;m BeforeTransaction&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GetAfterTransaction returns the current set afterTransaction, may be nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetAfterTransaction</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">	<span class="keyword">return</span> s.AfterTransaction</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AfterTransaction</span><span class="params">(ctx contractapi.TransactionContextInterface)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;i&#x27;m AfterTransaction&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">IgnoredMe</span><span class="params">(ctx contractapi.TransactionContextInterface)</span></span> &#123;</span><br><span class="line">	log.Printf(<span class="string">&quot;Ignored Me!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">GetIgnoredFunctions</span><span class="params">()</span> []<span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> []<span class="keyword">string</span>&#123;<span class="string">&quot;IgnoredMe&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="测试无法mock测试的shim-ChaincodeStubInterface方法">测试无法mock测试的<code>shim.ChaincodeStubInterface</code>方法</h3>
<p>一些其他的无法使用<code>shimtests</code>做mock测试的<code>shim.ChaincodeStubInterface</code>方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// SomeStubMethod stub其他的无法通过mock方式测试的方法练习</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">SomeStubMethod</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	stub := ctx.GetStub()</span><br><span class="line">	<span class="comment">// stub.GetArgs()和stub.GetStringArgs()都是获取调用链码时的入参，第一个参数时方法名，后面的参数是这个方法的参数的信息,如下：</span></span><br><span class="line">	<span class="comment">// 2021/01/25 08:06:32 stub.GetArgs(),i=0, arg=Practice_SmartContract:SomeStubMethod</span></span><br><span class="line">	<span class="comment">//2021/01/25 08:06:32 stub.GetArgs(),i=1, arg=asset1</span></span><br><span class="line">	<span class="keyword">for</span> i, arg := <span class="keyword">range</span> stub.GetArgs() &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;stub.GetArgs(),i=%d, arg=%s&quot;</span>, i, byteToString(arg))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i, arg := <span class="keyword">range</span> stub.GetStringArgs() &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;stub.GetStringArgs(),i=%d, arg=%s&quot;</span>, i, arg)</span><br><span class="line">	&#125;</span><br><span class="line">	binding, err := stub.GetBinding()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetBinding()=%s&quot;</span>, byteToString(binding))</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> stub.GetDecorations() &#123;</span><br><span class="line">		log.Printf(<span class="string">&quot;stub.GetDecorations(), k=%s, v=%s&quot;</span>, k, byteToString(v))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// stub.GetCreator()返回的是证书，如过是组织s2.supply.com的管理员发起的交易，则此处获得的是：Admin@s2.supply.com-cert.pem</span></span><br><span class="line">	creator, err := stub.GetCreator()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetCreator()=%s&quot;</span>, byteToString(creator))</span><br><span class="line">	<span class="comment">// 已经签名的提议，包含以下内容：</span></span><br><span class="line">	<span class="comment">// 1.通道名称</span></span><br><span class="line">	<span class="comment">// 2.链码名称</span></span><br><span class="line">	<span class="comment">// 3.发起交易的组织名称</span></span><br><span class="line">	<span class="comment">// 4.发起交易的人的证书</span></span><br><span class="line">	<span class="comment">// 5.调用链码时的入参：方法名，参数等</span></span><br><span class="line">	<span class="comment">// stub.GetSignedProposal().GetProposalBytes()的信息如下：</span></span><br><span class="line">	<span class="comment">//2021/01/25 08:06:32 stub.GetSignedProposal().GetProposalBytes()=</span></span><br><span class="line">	<span class="comment">//�</span></span><br><span class="line">	<span class="comment">//v��������&quot;alljoinchannel*@252b6bbd22eeaf2193cdbc86fe7bd9fa257e33a6209a5da7d81dcc41b8bb1b9d:secured_supply�</span></span><br><span class="line">	<span class="comment">//�</span></span><br><span class="line">	<span class="comment">//GylSOrg2MSP�-----BEGIN CERTIFICATE-----</span></span><br><span class="line">	<span class="comment">//MIICETCCAbegAwIBAgIRAJw2YUKkmyKusGHm33D7LhkwCgYIKoZIzj0EAwIwbTEL</span></span><br><span class="line">	<span class="comment">//MAkGA1UEBhMCVVMxEzARBgNVBAgTCkNhbGlmb3JuaWExFjAUBgNVBAcTDVNhbiBG</span></span><br><span class="line">	<span class="comment">//cmFuY2lzY28xFjAUBgNVBAoTDXMyLnN1cHBseS5jb20xGTAXBgNVBAMTEGNhLnMy</span></span><br><span class="line">	<span class="comment">//LnN1cHBseS5jb20wHhcNMjEwMTA3MDgzMTAwWhcNMzEwMTA1MDgzMTAwWjBYMQsw</span></span><br><span class="line">	<span class="comment">//CQYDVQQGEwJVUzETMBEGA1UECBMKQ2FsaWZvcm5pYTEWMBQGA1UEBxMNU2FuIEZy</span></span><br><span class="line">	<span class="comment">//YW5jaXNjbzEcMBoGA1UEAwwTQWRtaW5AczIuc3VwcGx5LmNvbTBZMBMGByqGSM49</span></span><br><span class="line">	<span class="comment">//AgEGCCqGSM49AwEHA0IABJ6An5vHmug1YBIUXKuD50ZJ79TiwDkW5uEr2ZkXU5Em</span></span><br><span class="line">	<span class="comment">//XwVlxwCOKpfqKOr1Xdk0DWMlAQPQIxeXktdVBJxFc4KjTTBLMA4GA1UdDwEB/wQE</span></span><br><span class="line">	<span class="comment">//AwIHgDAMBgNVHRMBAf8EAjAAMCsGA1UdIwQkMCKAIGO9q5qcp089i7bDqwyxRYdg</span></span><br><span class="line">	<span class="comment">//aX65Bvs4X5wCsXWbxj37MAoGCCqGSM49BAMCA0gAMEUCIQCRBC/uF8ooaLQzSDo6</span></span><br><span class="line">	<span class="comment">//e5+4UbBqjSi5MUy3IYfVrM5tHQIgaGHKXcKZY7q0Txs6LsbtayW6kWPOAee6Z1W8</span></span><br><span class="line">	<span class="comment">//top2VDc=</span></span><br><span class="line">	<span class="comment">//-----END CERTIFICATE-----</span></span><br><span class="line">	<span class="comment">//�w�&#125;dȧC&gt;�v�@�El�S����I</span></span><br><span class="line">	<span class="comment">//G</span></span><br><span class="line">	<span class="comment">//Esecured_supply/</span></span><br><span class="line">	<span class="comment">//%Practice_SmartContract:SomeStubMethod</span></span><br><span class="line">	<span class="comment">//asset1</span></span><br><span class="line">	proposal, err := stub.GetSignedProposal()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetSignedProposal()=%#v&quot;</span>, proposal)</span><br><span class="line">	bytes := proposal.GetProposalBytes()</span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetSignedProposal().GetProposalBytes()=%s&quot;</span>, byteToString(bytes))</span><br><span class="line">	p := &amp;peer.Proposal&#123;&#125;</span><br><span class="line">	err = proto.Unmarshal(bytes, p)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetSignedProposal().GetProposalBytes(),proto.Unmarshal=%#v&quot;</span>, p)</span><br><span class="line">	<span class="comment">//headerBytes:= p.GetHeader()</span></span><br><span class="line">	<span class="comment">//header := &amp;peer.ChaincodeHeaderExtension&#123;&#125;</span></span><br><span class="line">	<span class="comment">//err = proto.Unmarshal(headerBytes, header)</span></span><br><span class="line">	<span class="comment">//if err != nil &#123;</span></span><br><span class="line">	<span class="comment">//	return err</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="comment">//log.Printf(&quot;stub.GetSignedProposal().GetProposalBytes()-Proposal-GetHeader()=%#v&quot;, header)</span></span><br><span class="line">	<span class="comment">//payloadBytes := p.GetPayload()</span></span><br><span class="line">	<span class="comment">//payload := &amp;peer.ChaincodeProposalPayload&#123;&#125;</span></span><br><span class="line">	<span class="comment">//err = proto.Unmarshal(payloadBytes, payload)</span></span><br><span class="line">	<span class="comment">//if err != nil &#123;</span></span><br><span class="line">	<span class="comment">//	return err</span></span><br><span class="line">	<span class="comment">//&#125;</span></span><br><span class="line">	<span class="comment">//log.Printf(&quot;stub.GetSignedProposal().GetProposalBytes()-Proposal-GetPayload()=%#v&quot;, payload)</span></span><br><span class="line">	log.Printf(<span class="string">&quot;stub.GetSignedProposal().GetSignature()=%s&quot;</span>, byteToString(proposal.GetSignature()))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置一个Event</span></span><br><span class="line">	<span class="keyword">if</span> err := stub.SetEvent(<span class="string">&quot;hello event&quot;</span>, []<span class="keyword">byte</span>(<span class="string">&quot;hello&quot;</span>)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//2021/01/25 10:22:57 stub.GetHistoryForKey(asset1), next=&amp;queryresult.KeyModification&#123;</span></span><br><span class="line">	<span class="comment">//TxId:&quot;f251ce5352e294cd628fc0b5d09271ebe8253b41d66069c164195fe2783c3adc&quot;,</span></span><br><span class="line">	<span class="comment">//Value:[]uint8&#123;0x7b, 0x22, 0x49, 0x44, 0x22, 0x3a, 0x22, 0x61, 0x73, 0x73, 0x65, 0x74, 0x31, 0x22, 0x2c</span></span><br><span class="line">	<span class="comment">//, 0x22, 0x63, 0x6f, 0x6c, 0x6f, 0x72, 0x22, 0x3a, 0x22, 0x62, 0x6c, 0x75, 0x65, 0x22, 0x2c, 0x22, 0x73, 0x69, 0x7a, 0x65, 0x22, 0x3a, 0x35, 0x2c, 0x22, 0x6f, 0x77, 0x6e, 0x65, 0x72, 0x22, 0x3a, 0x22, 0x54, 0x6f, 0x6d, 0x6f, 0x6b, 0x6f, 0x22, 0x2c, 0x22, 0x61, 0x70, 0x70, 0x72, 0x61, 0x69, 0x73, 0x65, 0x64, 0x56, 0x61, 0x6c, 0x75, 0x65, 0x22, 0x3a, 0x33, 0x30, 0x30, 0x7d&#125;,</span></span><br><span class="line">	<span class="comment">//Timestamp:(*timestamp.Timestamp)(0xc00043d1a0),</span></span><br><span class="line">	<span class="comment">//IsDelete:false, XXX_NoUnkeyedLiteral:struct &#123;&#125;&#123;&#125;,</span></span><br><span class="line">	<span class="comment">//XXX_unrecognized:[]uint8(nil),</span></span><br><span class="line">	<span class="comment">//XXX_sizecache:0&#125;</span></span><br><span class="line">	assetHistory, err := stub.GetHistoryForKey(assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> assetHistory.Close()</span><br><span class="line">	<span class="keyword">for</span> assetHistory.HasNext() &#123;</span><br><span class="line">		next, err := assetHistory.Next()</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		log.Printf(<span class="string">&quot;stub.GetHistoryForKey(%s), next=%#v&quot;</span>, assetID, next)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">byteToString</span><span class="params">(data []<span class="keyword">byte</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	str := (*<span class="keyword">string</span>)(unsafe.Pointer(&amp;data))</span><br><span class="line">	<span class="keyword">return</span> *str</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>shim包下面也有一个<code>GetMSPID</code>方法，具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// GetMSPID returns the local mspid of the peer by checking the CORE_PEER_LOCALMSPID</span></span><br><span class="line"><span class="comment">// env var and returns an error if the env var is not set</span></span><br><span class="line"><span class="comment">// 通过检查环境变量CORE_PEER_LOCALMSPID返回peer节点本地的mspid，如果没有设置这个环境变量则返回一个error</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetMSPID</span><span class="params">()</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	mspid := os.Getenv(<span class="string">&quot;CORE_PEER_LOCALMSPID&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> mspid == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, errors.New(<span class="string">&quot;&#x27;CORE_PEER_LOCALMSPID&#x27; is not set&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> mspid, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TODO 待整合到一起</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> SPDX-License-Identifier: Apache-2.0</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/ptypes&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-chaincode-go/pkg/statebased&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-chaincode-go/shim&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/hyperledger/fabric-contract-api-go/contractapi&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	typeAssetForSale     = <span class="string">&quot;S&quot;</span></span><br><span class="line">	typeAssetBid         = <span class="string">&quot;B&quot;</span></span><br><span class="line">	typeAssetSaleReceipt = <span class="string">&quot;SR&quot;</span></span><br><span class="line">	typeAssetBuyReceipt  = <span class="string">&quot;BR&quot;</span></span><br><span class="line">	statusEnable         = <span class="string">&quot;enable&quot;</span></span><br><span class="line">	statusDelete         = <span class="string">&quot;delete&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SmartContract <span class="keyword">struct</span> &#123;</span><br><span class="line">	contractapi.Contract</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Asset struct and properties must be exported (start with capitals) to work with contract api metadata</span></span><br><span class="line"><span class="keyword">type</span> Asset <span class="keyword">struct</span> &#123;</span><br><span class="line">	ObjectType        <span class="keyword">string</span> <span class="string">`json:&quot;objectType&quot;`</span> <span class="comment">// ObjectType is used to distinguish different object types in the same chaincode namespace</span></span><br><span class="line">	ID                <span class="keyword">string</span> <span class="string">`json:&quot;assetID&quot;`</span></span><br><span class="line">	OwnerOrg          <span class="keyword">string</span> <span class="string">`json:&quot;ownerOrg&quot;`</span></span><br><span class="line">	PublicDescription <span class="keyword">string</span> <span class="string">`json:&quot;publicDescription&quot;`</span></span><br><span class="line">	Status            <span class="keyword">string</span> <span class="string">`json:&quot;status&quot;`</span></span><br><span class="line">	ParentID          <span class="keyword">string</span> <span class="string">`json:&quot;parentID&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> receipt <span class="keyword">struct</span> &#123;</span><br><span class="line">	price     <span class="keyword">int</span></span><br><span class="line">	timestamp time.Time</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AssetProperties 资产属性</span></span><br><span class="line"><span class="keyword">type</span> AssetProperties <span class="keyword">struct</span> &#123;</span><br><span class="line">	ObjectType <span class="keyword">string</span>    <span class="string">`json:&quot;objectType&quot;`</span> <span class="comment">// ObjectType is used to distinguish different object types in the same chaincode namespace</span></span><br><span class="line">	ID         <span class="keyword">string</span>    <span class="string">`json:&quot;assetID&quot;`</span></span><br><span class="line">	Issuer     <span class="keyword">string</span>    <span class="string">`json:&quot;issuer&quot;`</span></span><br><span class="line">	Amount     <span class="keyword">int</span>       <span class="string">`json:&quot;amount&quot;`</span></span><br><span class="line">	CreateDate time.Time <span class="string">`json:&quot;createDate&quot;`</span></span><br><span class="line">	EndDate    time.Time <span class="string">`json:&quot;endDate&quot;`</span></span><br><span class="line">	Salt       <span class="keyword">string</span>    <span class="string">`json:&quot;salt&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateAsset creates an asset and sets it as owned by the client&#x27;s org</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">CreateAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID, publicDescription <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// 获取临时数据库的数据，返回一个map[string][]byte</span></span><br><span class="line">	transientMap, err := ctx.GetStub().GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error getting transient: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Asset properties must be retrieved from the transient field as they are private</span></span><br><span class="line">	immutablePropertiesJSON, ok := transientMap[<span class="string">&quot;asset_properties&quot;</span>]</span><br><span class="line">	fmt.Println(<span class="string">&quot;immutablePropertiesJSON:&quot;</span>, immutablePropertiesJSON)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;asset_properties key not found in the transient map&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> createAsset(ctx, immutablePropertiesJSON, assetID, publicDescription, <span class="string">&quot;&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// CreateAsset creates an asset and sets it as owned by the client&#x27;s org</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, immutablePropertiesJSON []<span class="keyword">byte</span>, assetID, publicDescription <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	parentID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// Get client org id and verify it matches peer org id.</span></span><br><span class="line">	<span class="comment">// In this scenario, client is only authorized to read/write private data from its own peer.</span></span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">true</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;clientOrgID:&quot;</span>, clientOrgID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	asset := Asset&#123;</span><br><span class="line">		ObjectType:        <span class="string">&quot;asset&quot;</span>,</span><br><span class="line">		ID:                assetID,</span><br><span class="line">		OwnerOrg:          clientOrgID,</span><br><span class="line">		PublicDescription: publicDescription,</span><br><span class="line">		Status:            statusEnable,</span><br><span class="line">		ParentID:          parentID,</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;asset:&quot;</span>, asset)</span><br><span class="line">	assetBytes, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create asset JSON: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().PutState(asset.ID, assetBytes)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put asset in public data: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Set the endorsement policy such that an owner org peer is required to endorse future updates</span></span><br><span class="line">	err = setAssetStateBasedEndorsement(ctx, asset.ID, clientOrgID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed setting state based endorsement for owner: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Persist private immutable asset properties to owner&#x27;s private data collection</span></span><br><span class="line">	collection := buildCollectionName(clientOrgID)</span><br><span class="line">	fmt.Println(<span class="string">&quot;collection:&quot;</span>, collection)</span><br><span class="line">	err = ctx.GetStub().PutPrivateData(collection, asset.ID, immutablePropertiesJSON)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put Asset private details: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// // verifyAssetProperties 验证资产属性的信息</span></span><br><span class="line"><span class="comment">// func verifyAssetProperties(immutablePropertiesJSON []byte, asset Asset) error &#123;</span></span><br><span class="line"><span class="comment">// 	assetProperties, err := getAssetProperties(immutablePropertiesJSON)</span></span><br><span class="line"><span class="comment">// 	if err != nil &#123;</span></span><br><span class="line"><span class="comment">// 		return err</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	// 资产的属性ID和资产ID相同</span></span><br><span class="line"><span class="comment">// 	if asset.ID != assetProperties.ID &#123;</span></span><br><span class="line"><span class="comment">// 		return fmt.Errorf(&quot;资产ID和资产属性ID必须相同&quot;)</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	// 资产的发行者就是资产的创建者，所有人都可以发行，但是别人认不认可这个组织发行的资产是另一回事</span></span><br><span class="line"><span class="comment">// 	if asset.OwnerOrg != assetProperties.Issuer &#123;</span></span><br><span class="line"><span class="comment">// 		return fmt.Errorf(&quot;资产的发行方必须是当前创建资产的组织&quot;)</span></span><br><span class="line"><span class="comment">// 	&#125;</span></span><br><span class="line"><span class="comment">// 	// 理论上这里应该还有更多的校验，比如说创建时间和失效时间的验证</span></span><br><span class="line"><span class="comment">// 	return nil</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">// ChangePublicDescription updates the assets public description. Only the current owner can update the public description</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">ChangePublicDescription</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, newDescription <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get asset: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> changeOriginAssetInfo(ctx, *asset, <span class="string">&quot;&quot;</span>, newDescription)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AgreeToSell adds seller&#x27;s asking price to seller&#x27;s implicit private data collection</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AgreeToSell</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">true</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify that this clientOrgId actually owns the asset.</span></span><br><span class="line">	<span class="keyword">if</span> clientOrgID != asset.OwnerOrg &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;a client from %s cannot sell an asset owned by %s&quot;</span>, clientOrgID, asset.OwnerOrg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> agreeToPrice(ctx, assetID, typeAssetForSale)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AgreeToBuy adds buyer&#x27;s bid price to buyer&#x27;s implicit private data collection</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">AgreeToBuy</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> agreeToPrice(ctx, assetID, typeAssetBid)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// agreeToPrice adds a bid or ask price to caller&#x27;s implicit private data collection</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">agreeToPrice</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, priceType <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// In this scenario, client is only authorized to read/write private data from its own peer.</span></span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">true</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transMap, err := ctx.GetStub().GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error getting transient: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Asset price must be retrieved from the transient field as they are private</span></span><br><span class="line">	price, ok := transMap[<span class="string">&quot;asset_price&quot;</span>]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;asset_price key not found in the transient map&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	collection := buildCollectionName(clientOrgID)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Persist the agreed to price in a collection sub-namespace based on priceType key prefix,</span></span><br><span class="line">	<span class="comment">// to avoid collisions between private asset properties, sell price, and buy price</span></span><br><span class="line">	assetPriceKey, err := ctx.GetStub().CreateCompositeKey(priceType, []<span class="keyword">string</span>&#123;assetID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// The Price hash will be verified later, therefore always pass and persist price bytes as is,</span></span><br><span class="line">	<span class="comment">// so that there is no risk of nondeterministic marshaling.</span></span><br><span class="line">	err = ctx.GetStub().PutPrivateData(collection, assetPriceKey, price)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put asset bid: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// VerifyAssetProperties  Allows a buyer to validate the properties of</span></span><br><span class="line"><span class="comment">// an asset against the owner&#x27;s implicit private data collection</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">VerifyAssetProperties</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	transMap, err := ctx.GetStub().GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;error getting transient: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/// Asset properties must be retrieved from the transient field as they are private</span></span><br><span class="line">	immutablePropertiesJSON, ok := transMap[<span class="string">&quot;asset_properties&quot;</span>]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;asset_properties key not found in the transient map&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	asset, err := s.ReadAsset(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;failed to get asset: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加资产状态的验证</span></span><br><span class="line">	<span class="keyword">if</span> (*asset).Status != statusEnable &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;资产不可以，不允许交易: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	collectionOwner := buildCollectionName(asset.OwnerOrg)</span><br><span class="line">	immutablePropertiesOnChainHash, err := ctx.GetStub().GetPrivateDataHash(collectionOwner, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;failed to read asset private properties hash from seller&#x27;s collection: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> immutablePropertiesOnChainHash == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;asset private properties hash does not exist: %s&quot;</span>, assetID)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hash := sha256.New()</span><br><span class="line">	hash.Write(immutablePropertiesJSON)</span><br><span class="line">	calculatedPropertiesHash := hash.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// verify that the hash of the passed immutable properties matches the on-chain hash</span></span><br><span class="line">	<span class="keyword">if</span> !bytes.Equal(immutablePropertiesOnChainHash, calculatedPropertiesHash) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, fmt.Errorf(<span class="string">&quot;hash %x for passed immutable properties %s does not match on-chain hash %x&quot;</span>,</span><br><span class="line">			calculatedPropertiesHash,</span><br><span class="line">			immutablePropertiesJSON,</span><br><span class="line">			immutablePropertiesOnChainHash,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TransferAsset checks transfer conditions and then transfers asset state to buyer.</span></span><br><span class="line"><span class="comment">// TransferAsset can only be called by current owner</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">TransferAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, buyerOrgID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	transMap, err := ctx.GetStub().GetTransient()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error getting transient data: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	immutablePropertiesJSON, ok := transMap[<span class="string">&quot;asset_properties&quot;</span>]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;asset_properties key not found in the transient map&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	priceJSON, ok := transMap[<span class="string">&quot;asset_price&quot;</span>]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;asset_price key not found in the transient map&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> agreement Agreement</span><br><span class="line">	err = json.Unmarshal(priceJSON, &amp;agreement)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to unmarshal price JSON: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	asset, err := s.ReadAsset(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get asset: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加资产状态的验证</span></span><br><span class="line">	<span class="keyword">if</span> (*asset).Status != statusEnable &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;资产不可以，不允许交易&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = verifyTransferConditions(ctx, asset, immutablePropertiesJSON, clientOrgID, buyerOrgID, priceJSON)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed transfer verification: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = transferAssetState(ctx, asset, immutablePropertiesJSON, clientOrgID, buyerOrgID, agreement.Price)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed asset transfer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// SplitAsset 拆分资产为两个资产，传入的amount是拆分后的其中一个资产的金额</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SmartContract)</span> <span class="title">SplitAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, amount <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset, err := s.ReadAsset(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	immutableProperties, err := getAssetPrivateProperties(ctx, assetID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	assetProperties, err := getAssetProperties(immutableProperties)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> assetProperties.Amount &lt;= amount &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;资产ID的金额为%d小于想要拆分的金额为%d，不允许拆分&quot;</span>, assetProperties.Amount, amount)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := splitAsset(ctx, assetProperties, assetID+<span class="string">&quot;1&quot;</span>, amount, *asset); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := splitAsset(ctx, assetProperties, assetID+<span class="string">&quot;2&quot;</span>, assetProperties.Amount-amount, *asset); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 拆分之后删除旧资产</span></span><br><span class="line">	collection := buildCollectionName((*asset).OwnerOrg)</span><br><span class="line">	err = ctx.GetStub().DelPrivateData(collection, asset.ID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to delete Asset private details from org: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 修改公共资产信息</span></span><br><span class="line">	changeOriginAssetInfo(ctx, *asset, statusDelete, <span class="string">&quot;已拆分&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据transient获取的assetProperties的字节数组获取AssetProperties</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getAssetProperties</span><span class="params">(immutablePropertiesJSON []<span class="keyword">byte</span>)</span> <span class="params">(AssetProperties, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> assetProperties AssetProperties</span><br><span class="line">	<span class="keyword">if</span> err := json.Unmarshal(immutablePropertiesJSON, &amp;assetProperties); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> assetProperties, fmt.Errorf(<span class="string">&quot;failed to unmarshal price JSON: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> assetProperties, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ChangePublicDescription updates the assets public description. Only the current owner can update the public description</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">changeOriginAssetInfo</span><span class="params">(ctx contractapi.TransactionContextInterface, asset Asset, status <span class="keyword">string</span>, newDescription <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// No need to check client org id matches peer org id, rely on the asset ownership check instead.</span></span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Auth check to ensure that client&#x27;s org actually owns the asset</span></span><br><span class="line">	<span class="keyword">if</span> clientOrgID != asset.OwnerOrg &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;a client from %s cannot update the description of a asset owned by %s&quot;</span>, clientOrgID, asset.OwnerOrg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加资产状态的验证</span></span><br><span class="line">	<span class="keyword">if</span> asset.Status != statusEnable &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;资产不可用，不允许修改&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> status != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		asset.Status = status</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> newDescription != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		asset.PublicDescription = newDescription</span><br><span class="line">	&#125;</span><br><span class="line">	updatedAssetJSON, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to marshal asset: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().PutState(asset.ID, updatedAssetJSON)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// splitAsset 从原始资产属性拆分成指定ID和金额的资产</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">splitAsset</span><span class="params">(ctx contractapi.TransactionContextInterface, originAssetProperties AssetProperties, newAssetID <span class="keyword">string</span>, newAmount <span class="keyword">int</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	asset Asset)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	originAssetProperties.Amount = newAmount</span><br><span class="line">	originAssetProperties.ID = newAssetID</span><br><span class="line">	immutablePropertiesJSON, err := json.Marshal(originAssetProperties)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> createAsset(ctx, immutablePropertiesJSON, newAssetID, asset.PublicDescription, asset.ID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// verifyTransferConditions checks that client org currently owns asset and that both parties have agreed on price</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyTransferConditions</span><span class="params">(ctx contractapi.TransactionContextInterface,</span></span></span><br><span class="line"><span class="function"><span class="params">	asset *Asset,</span></span></span><br><span class="line"><span class="function"><span class="params">	immutablePropertiesJSON []<span class="keyword">byte</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	clientOrgID <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	buyerOrgID <span class="keyword">string</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">	priceJSON []<span class="keyword">byte</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CHECK1: Auth check to ensure that client&#x27;s org actually owns the asset</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> clientOrgID != asset.OwnerOrg &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;a client from %s cannot transfer a asset owned by %s&quot;</span>, clientOrgID, asset.OwnerOrg)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CHECK2: Verify that the hash of the passed immutable properties matches the on-chain hash</span></span><br><span class="line"></span><br><span class="line">	collectionSeller := buildCollectionName(clientOrgID)</span><br><span class="line">	immutablePropertiesOnChainHash, err := ctx.GetStub().GetPrivateDataHash(collectionSeller, asset.ID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to read asset private properties hash from seller&#x27;s collection: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> immutablePropertiesOnChainHash == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;asset private properties hash does not exist: %s&quot;</span>, asset.ID)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hash := sha256.New()</span><br><span class="line">	hash.Write(immutablePropertiesJSON)</span><br><span class="line">	calculatedPropertiesHash := hash.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// verify that the hash of the passed immutable properties matches the on-chain hash</span></span><br><span class="line">	<span class="keyword">if</span> !bytes.Equal(immutablePropertiesOnChainHash, calculatedPropertiesHash) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;hash %x for passed immutable properties %s does not match on-chain hash %x&quot;</span>,</span><br><span class="line">			calculatedPropertiesHash,</span><br><span class="line">			immutablePropertiesJSON,</span><br><span class="line">			immutablePropertiesOnChainHash,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// CHECK3: Verify that seller and buyer agreed on the same price</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get sellers asking price</span></span><br><span class="line">	assetForSaleKey, err := ctx.GetStub().CreateCompositeKey(typeAssetForSale, []<span class="keyword">string</span>&#123;asset.ID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	sellerPriceHash, err := ctx.GetStub().GetPrivateDataHash(collectionSeller, assetForSaleKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get seller price hash: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> sellerPriceHash == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;seller price for %s does not exist&quot;</span>, asset.ID)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Get buyers bid price</span></span><br><span class="line">	collectionBuyer := buildCollectionName(buyerOrgID)</span><br><span class="line">	assetBidKey, err := ctx.GetStub().CreateCompositeKey(typeAssetBid, []<span class="keyword">string</span>&#123;asset.ID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// TODO 疑问：这个方法是由资产拥有者调用的，那么资产拥有者怎么可以获取资产买方的出价信息呢？如果是从公共状态获取购买方的出价hash是没问题的，但是从购买方的私有数据集中获取出价hash很让人费解。</span></span><br><span class="line">	buyerPriceHash, err := ctx.GetStub().GetPrivateDataHash(collectionBuyer, assetBidKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to get buyer price hash: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> buyerPriceHash == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;buyer price for %s does not exist&quot;</span>, asset.ID)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	hash = sha256.New()</span><br><span class="line">	hash.Write(priceJSON)</span><br><span class="line">	calculatedPriceHash := hash.Sum(<span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify that the hash of the passed price matches the on-chain sellers price hash</span></span><br><span class="line">	<span class="keyword">if</span> !bytes.Equal(calculatedPriceHash, sellerPriceHash) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;hash %x for passed price JSON %s does not match on-chain hash %x, seller hasn&#x27;t agreed to the passed trade id and price&quot;</span>,</span><br><span class="line">			calculatedPriceHash,</span><br><span class="line">			priceJSON,</span><br><span class="line">			sellerPriceHash,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Verify that the hash of the passed price matches the on-chain buyer price hash</span></span><br><span class="line">	<span class="keyword">if</span> !bytes.Equal(calculatedPriceHash, buyerPriceHash) &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;hash %x for passed price JSON %s does not match on-chain hash %x, buyer hasn&#x27;t agreed to the passed trade id and price&quot;</span>,</span><br><span class="line">			calculatedPriceHash,</span><br><span class="line">			priceJSON,</span><br><span class="line">			buyerPriceHash,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// transferAssetState performs the public and private state updates for the transferred asset</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">transferAssetState</span><span class="params">(ctx contractapi.TransactionContextInterface, asset *Asset, immutablePropertiesJSON []<span class="keyword">byte</span>, clientOrgID <span class="keyword">string</span>, buyerOrgID <span class="keyword">string</span>, price <span class="keyword">int</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	asset.OwnerOrg = buyerOrgID</span><br><span class="line">	updatedAsset, err := json.Marshal(asset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().PutState(asset.ID, updatedAsset)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to write asset for buyer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Change the endorsement policy to the new owner</span></span><br><span class="line">	err = setAssetStateBasedEndorsement(ctx, asset.ID, buyerOrgID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed setting state based endorsement for new owner: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Transfer the private properties (delete from seller collection, create in buyer collection)</span></span><br><span class="line">	collectionSeller := buildCollectionName(clientOrgID)</span><br><span class="line">	err = ctx.GetStub().DelPrivateData(collectionSeller, asset.ID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to delete Asset private details from seller: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	collectionBuyer := buildCollectionName(buyerOrgID)</span><br><span class="line">	err = ctx.GetStub().PutPrivateData(collectionBuyer, asset.ID, immutablePropertiesJSON)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put Asset private properties for buyer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete the price records for seller</span></span><br><span class="line">	assetPriceKey, err := ctx.GetStub().CreateCompositeKey(typeAssetForSale, []<span class="keyword">string</span>&#123;asset.ID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key for seller: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().DelPrivateData(collectionSeller, assetPriceKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to delete asset price from implicit private data collection for seller: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Delete the price records for buyer</span></span><br><span class="line">	assetPriceKey, err = ctx.GetStub().CreateCompositeKey(typeAssetBid, []<span class="keyword">string</span>&#123;asset.ID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key for buyer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().DelPrivateData(collectionBuyer, assetPriceKey)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to delete asset price from implicit private data collection for buyer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Keep record for a &#x27;receipt&#x27; in both buyers and sellers private data collection to record the sale price and date.</span></span><br><span class="line">	<span class="comment">// Persist the agreed to price in a collection sub-namespace based on receipt key prefix.</span></span><br><span class="line">	receiptBuyKey, err := ctx.GetStub().CreateCompositeKey(typeAssetBuyReceipt, []<span class="keyword">string</span>&#123;asset.ID, ctx.GetStub().GetTxID()&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key for receipt: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	txTimestamp, err := ctx.GetStub().GetTxTimestamp()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create timestamp for receipt: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	timestamp, err := ptypes.Timestamp(txTimestamp)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	assetReceipt := receipt&#123;</span><br><span class="line">		price:     price,</span><br><span class="line">		timestamp: timestamp,</span><br><span class="line">	&#125;</span><br><span class="line">	receipt, err := json.Marshal(assetReceipt)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to marshal receipt: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().PutPrivateData(collectionBuyer, receiptBuyKey, receipt)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put private asset receipt for buyer: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	receiptSaleKey, err := ctx.GetStub().CreateCompositeKey(typeAssetSaleReceipt, []<span class="keyword">string</span>&#123;ctx.GetStub().GetTxID(), asset.ID&#125;)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create composite key for receipt: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = ctx.GetStub().PutPrivateData(collectionSeller, receiptSaleKey, receipt)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to put private asset receipt for seller: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getClientOrgID gets the client org ID.</span></span><br><span class="line"><span class="comment">// The client org ID can optionally be verified against the peer org ID, to ensure that a client</span></span><br><span class="line"><span class="comment">// from another org doesn&#x27;t attempt to read or write private data from this peer.</span></span><br><span class="line"><span class="comment">// The only exception in this scenario is for TransferAsset, since the current owner</span></span><br><span class="line"><span class="comment">// needs to get an endorsement from the buyer&#x27;s peer.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClientOrgID</span><span class="params">(ctx contractapi.TransactionContextInterface, verifyOrg <span class="keyword">bool</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// GetClientIdentity()获取客户端的身份，返回ClientIdentity接口，这个接口有如下方法：</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// GetID returns the ID associated with the invoking identity.  This ID</span></span><br><span class="line">	<span class="comment">// is guaranteed to be unique within the MSP.</span></span><br><span class="line">	<span class="comment">// * GetID() (string, error) 获取</span></span><br><span class="line"></span><br><span class="line">	clientOrgID, err := ctx.GetClientIdentity().GetMSPID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;failed getting client&#x27;s orgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> verifyOrg &#123;</span><br><span class="line">		err = verifyClientOrgMatchesPeerOrg(clientOrgID)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> clientOrgID, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// verifyClientOrgMatchesPeerOrg checks the client org id matches the peer org id.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">verifyClientOrgMatchesPeerOrg</span><span class="params">(clientOrgID <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	peerOrgID, err := shim.GetMSPID()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed getting peer&#x27;s orgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> clientOrgID != peerOrgID &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;client from org %s is not authorized to read or write private data from an org %s peer&quot;</span>,</span><br><span class="line">			clientOrgID,</span><br><span class="line">			peerOrgID,</span><br><span class="line">		)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setAssetStateBasedEndorsement adds an endorsement policy to a asset so that only a peer from an owning org</span></span><br><span class="line"><span class="comment">// can update or transfer the asset.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">setAssetStateBasedEndorsement</span><span class="params">(ctx contractapi.TransactionContextInterface, assetID <span class="keyword">string</span>, orgToEndorse <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	endorsementPolicy, err := statebased.NewStateEP(<span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	err = endorsementPolicy.AddOrgs(statebased.RoleTypeMember, orgToEndorse)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to add org to endorsement policy: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	policy, err := endorsementPolicy.Policy()</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;failed to create endorsement policy bytes from org: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;assetID=%s, orgToEndorse=%s, policy=%s, len(policy)=%d \n&quot;, assetID, orgToEndorse, policy, len(policy))</span></span><br><span class="line">	<span class="comment">// fmt.Printf(&quot;assetID=%s, policy=%s, endorsementPolicy.ListOrgs=%s\n&quot;, assetID, string(policy[:]), endorsementPolicy.ListOrgs())</span></span><br><span class="line">	<span class="keyword">return</span> ctx.GetStub().SetStateValidationParameter(assetID, policy)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">buildCollectionName</span><span class="params">(clientOrgID <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(<span class="string">&quot;_implicit_org_%s&quot;</span>, clientOrgID)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClientImplicitCollectionName</span><span class="params">(ctx contractapi.TransactionContextInterface)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</span><br><span class="line">	clientOrgID, err := getClientOrgID(ctx, <span class="literal">true</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, fmt.Errorf(<span class="string">&quot;failed to get verified OrgID: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = verifyClientOrgMatchesPeerOrg(clientOrgID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buildCollectionName(clientOrgID), <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	chaincode, err := contractapi.NewChaincode(<span class="built_in">new</span>(SmartContract))</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panicf(<span class="string">&quot;Error create transfer asset chaincode: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err := chaincode.Start(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Panicf(<span class="string">&quot;Error starting asset chaincode: %v&quot;</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6%E9%87%8C%E9%9D%A2%E7%9A%84%E6%96%B9%E6%B3%95%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text">智能合约里面的方法如何定义的</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mock%E6%96%B9%E5%BC%8F%E6%B5%8B%E8%AF%95shim-ChaincodeStubInterface%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.</span> <span class="toc-text">mock方式测试shim.ChaincodeStubInterface中的方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%97%A0%E6%B3%95mock%E6%B5%8B%E8%AF%95%E7%9A%84shim-ChaincodeStubInterface%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">测试无法mock测试的shim.ChaincodeStubInterface方法</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&text=Fabric智能合约API学习"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&is_video=false&description=Fabric智能合约API学习"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Fabric智能合约API学习&body=Check out this article: https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&title=Fabric智能合约API学习"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&name=Fabric智能合约API学习&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/blockchain/fabric/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/Fabric%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6API%E5%AD%A6%E4%B9%A0/&t=Fabric智能合约API学习"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    guozhe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
