<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="背景 由于公司iaas人员在操作虚拟ip时手误，导致应该指向mysql主库的虚拟ip指向了从库。因为业务app使用的是虚拟ip链接的数据库，因此导致所有的业务数据都写入了从库，而主库的数据从此没有任何变化。 为了解决此问题，需要把原来的主库变成从库，从而继续保持mysql数据库的高可用；但是在处理的时候发现由于旧从库配置的bin-log超时时间为：expire-logs-days  &#x3D;  3，这导">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL数据库备份并添加主从复制">
<meta property="og:url" content="https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/index.html">
<meta property="og:site_name" content="滴水成涓">
<meta property="og:description" content="背景 由于公司iaas人员在操作虚拟ip时手误，导致应该指向mysql主库的虚拟ip指向了从库。因为业务app使用的是虚拟ip链接的数据库，因此导致所有的业务数据都写入了从库，而主库的数据从此没有任何变化。 为了解决此问题，需要把原来的主库变成从库，从而继续保持mysql数据库的高可用；但是在处理的时候发现由于旧从库配置的bin-log超时时间为：expire-logs-days  &#x3D;  3，这导">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-11-22T06:32:06.497Z">
<meta property="article:modified_time" content="2024-11-22T06:32:06.497Z">
<meta property="article:author" content="guozhe">
<meta property="article:tag" content="MySQL">
<meta property="article:tag" content="主从复制">
<meta property="article:tag" content="MySQL备份">
<meta name="twitter:card" content="summary">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>MySQL数据库备份并添加主从复制</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="滴水成涓" type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2024/11/22/others/ubuntu%E7%B3%BB%E7%BB%9F%E4%B8%8Bnvidia%E6%98%BE%E5%8D%A1%E8%B6%85%E9%A2%91%E8%AE%BE%E7%BD%AE/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2024/11/22/others/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-%E3%80%8A%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E6%9C%AC%E4%BF%9D%E9%99%A9%E6%8C%87%E5%8D%97%E3%80%8B/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&text=MySQL数据库备份并添加主从复制"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&is_video=false&description=MySQL数据库备份并添加主从复制"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MySQL数据库备份并添加主从复制&body=Check out this article: https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&name=MySQL数据库备份并添加主从复制&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&t=MySQL数据库备份并添加主从复制"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">基本信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E5%A6%82%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">具体操作如下</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Percona-XtraBackup"><span class="toc-number">2.1.</span> <span class="toc-text">安装Percona XtraBackup</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">错误处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Percona-XtraBackup"><span class="toc-number">2.2.</span> <span class="toc-text">使用Percona XtraBackup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%87%E4%BB%BDmaster"><span class="toc-number">2.2.1.</span> <span class="toc-text">备份master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.2.2.</span> <span class="toc-text">数据文件一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-number">2.2.3.</span> <span class="toc-text">数据恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AEcopy%E5%AF%BC32%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">把备份数据copy导32服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2mysql"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">停止mysql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E5%92%8C%E5%88%A0%E9%99%A4%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">备份和删除历史数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">创建新的数据文件夹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D-v2"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">数据恢复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%A4%B9%E7%BB%99mysql%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.3.6.</span> <span class="toc-text">授权数据文件夹给mysql用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.2.3.7.</span> <span class="toc-text">启动数据库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.4.</span> <span class="toc-text">添加主从复制配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">错误记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xtrabackup-Can%E2%80%99t-change-dir-to-%E2%80%98-var-lib-mysql%E2%80%99-Errcode-2-No-such-file-or-directory"><span class="toc-number">3.1.</span> <span class="toc-text">xtrabackup: Can’t change dir to ‘&#x2F;var&#x2F;lib&#x2F;mysql’ (Errcode: 2 - No such file or directory)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%9C%BA%E6%99%AF"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">错误场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.1.0.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERROR-Can%E2%80%99t-start-server-Bind-on-TCP-IP-port-Got-error-98-Address-already-in-use"><span class="toc-number">3.2.</span> <span class="toc-text">[ERROR] Can’t start server: Bind on TCP&#x2F;IP port. Got error: 98: Address already in use</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-v2"><span class="toc-number">3.2.1.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        MySQL数据库备份并添加主从复制
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">guozhe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-11-22T06:32:06.497Z" itemprop="datePublished">2024-11-22</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/MySQL/">MySQL</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/MySQL/" rel="tag">MySQL</a>, <a class="tag-link-link" href="/tags/MySQL%E5%A4%87%E4%BB%BD/" rel="tag">MySQL备份</a>, <a class="tag-link-link" href="/tags/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" rel="tag">主从复制</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="背景">背景</h2>
<p>由于公司iaas人员在操作虚拟ip时手误，导致应该指向mysql主库的虚拟ip指向了从库。因为业务app使用的是虚拟ip链接的数据库，因此导致所有的业务数据都写入了从库，而主库的数据从此没有任何变化。</p>
<p>为了解决此问题，需要把原来的主库变成从库，从而继续保持mysql数据库的高可用；但是在处理的时候发现由于旧从库配置的bin-log超时时间为：<code>expire-logs-days  =  3</code>，这导致了3天前的bin-log已经因为过期而被清除。所以如果直接把旧的主库当作从库来进行主从复制，会导数据不一致。</p>
<p>因此最终需要把旧主库的数据全部清除，然后从旧从库导出所有数据再导入旧主库，最后再添加主从复制来达到此目的。</p>
<h3 id="基本信息">基本信息</h3>
<p>旧主库ip：172.99.0.32</p>
<p>旧从库ip：172.99.0.31</p>
<h2 id="具体操作如下">具体操作如下</h2>
<p>因为一共有三个数据库，查看数据库的data目录共200G以上的数据量，因此不能使用mysqldump来进行导入和导出备份。最终确定使用Percona XtraBackup工具进行备份和恢复数据。</p>
<h3 id="安装Percona-XtraBackup">安装<em>Percona XtraBackup</em></h3>
<p>参考<a target="_blank" rel="noopener" href="https://www.percona.com/doc/percona-xtrabackup/2.4/installation/yum_repo.html">官方文档</a>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.Install the percona-release configuration tool</span></span><br><span class="line">yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.Testing the repository</span></span><br><span class="line">yum list | grep percona</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.Enable the repository:</span></span><br><span class="line">percona-release enable-only tools release</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.Install Percona XtraBackup</span></span><br><span class="line">yum install percona-xtrabackup-24</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="错误处理">错误处理</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> yum install https://repo.percona.com/yum/percona-release-latest.noarch.rpm</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Setting up Install Process</span><br><span class="line">percona-release-latest.noarch.rpm                                                                                                                                                    |  20 kB     00:00</span><br><span class="line">Examining /var/tmp/yum-root-3a5UYo/percona-release-latest.noarch.rpm: percona-release-1.0-27.noarch</span><br><span class="line">Marking /var/tmp/yum-root-3a5UYo/percona-release-latest.noarch.rpm to be installed</span><br><span class="line">Determining fastest mirrors</span><br><span class="line">YumRepo Error: All mirror URLs are not using ftp, http[s] or file.</span><br><span class="line"> Eg. Invalid release/repo/arch combination/</span><br><span class="line">removing mirrorlist with no valid mirrors: /var/cache/yum/x86_64/6/base/mirrorlist.txt</span><br><span class="line">Error: Cannot find a valid baseurl for repo: base</span><br></pre></td></tr></table></figure>
<p>解决方案：</p>
<ul>
<li>把源替换为清华大学源，<a target="_blank" rel="noopener" href="https://mirror.tuna.tsinghua.edu.cn/help/centos-vault/">参考文档</a></li>
<li>查看当前系统的版本：<code>more /etc/issue</code></li>
<li>如果<code>sudo yum makecache</code>报错，先执行<code>yum clean all</code></li>
<li>如果<code>sudo yum makecache</code>依旧报错（[Errno 14] Peer cert cannot be verified or peer cert invalid），追加<code>sslverify=false</code>导<code>/etc/yum.conf</code>文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum makecache</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Determining fastest mirrors</span><br><span class="line">epel/metalink                                                                                                                                                                        | 4.4 kB     00:00</span><br><span class="line"> * epel: ftp.iij.ad.jp</span><br><span class="line">https://mirrors.tuna.tsinghua.edu.cn/centos-vault/6.8/os/x86_64/repodata/repomd.xml: [Errno 14] Peer cert cannot be verified or peer cert invalid</span><br><span class="line">Trying other mirror.</span><br><span class="line">It was impossible to connect to the Red Hat servers.</span><br><span class="line">This could mean a connectivity issue in your environment, such as the requirement to configure a proxy,</span><br><span class="line">or a transparent proxy that tampers with TLS security, or an incorrect system clock.</span><br><span class="line">Please collect information about the specific failure that occurs in your environment,</span><br><span class="line">using the instructions in: https://access.redhat.com/solutions/1527033 and open a ticket with Red Hat Support.</span><br><span class="line"></span><br><span class="line">Error: Cannot retrieve repository metadata (repomd.xml) for repository: base. Please verify its path and try again</span><br></pre></td></tr></table></figure>
<h3 id="使用Percona-XtraBackup">使用<em>Percona XtraBackup</em></h3>
<p>参考<a target="_blank" rel="noopener" href="https://www.percona.com/doc/percona-xtrabackup/2.4/index.html">官方文档</a></p>
<h4 id="备份master">备份master</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --defaults-file=/data/mysql/mysql_3306/my_3306.cnf --host=127.0.0.1 --port=3306 --user=root --password=123456 /data/backup</span><br></pre></td></tr></table></figure>
<p>查看备份文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ll</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-x--- 5 root root 4096 Mar 25 11:34 2022-03-25_10-56-55</span><br><span class="line">drwxr-x--- 7 root root 4096 Mar 25 15:10 2022-03-25_14-49-59</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ll 2022-03-25_14-49-59</span></span><br><span class="line">total 2108548</span><br><span class="line">-rw-r----- 1 root root        437 Mar 25 15:10 backup-my.cnf</span><br><span class="line">drwxr-x--- 2 root root      16384 Mar 25 15:10 db1</span><br><span class="line">drwxr-x--- 2 root root     176128 Mar 25 15:10 db2</span><br><span class="line">drwxr-x--- 2 root root       8192 Mar 25 15:10 db3</span><br><span class="line">-rw-r----- 1 root root   10656571 Mar 25 15:10 ib_buffer_pool</span><br><span class="line">-rw-r----- 1 root root 2147483648 Mar 25 14:50 ibdata1</span><br><span class="line">drwxr-x--- 2 root root       4096 Mar 25 15:10 mysql</span><br><span class="line">drwxr-x--- 2 root root       4096 Mar 25 15:10 performance_schema</span><br><span class="line">-rw-r----- 1 root root         46 Mar 25 15:10 xtrabackup_binlog_info</span><br><span class="line">-rw-r----- 1 root root        150 Mar 25 15:10 xtrabackup_checkpoints</span><br><span class="line">-rw-r----- 1 root root        630 Mar 25 15:10 xtrabackup_info</span><br><span class="line">-rw-r----- 1 root root     731648 Mar 25 15:10 xtrabackup_logfile</span><br></pre></td></tr></table></figure>
<h4 id="数据文件一致性">数据文件一致性</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --apply-log /data/backup/2022-03-25_14-49-59</span><br></pre></td></tr></table></figure>
<h4 id="数据恢复">数据恢复</h4>
<h5 id="把备份数据copy导32服务器">把备份数据copy导32服务器</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp -r /data/backup/2022-03-25_14-49-59/ iaas@172.99.0.32:/data/backup_20220325</span><br></pre></td></tr></table></figure>
<h5 id="停止mysql">停止mysql</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo su</span><br><span class="line"></span><br><span class="line">mysqladmin --port=3306 -uroot -p12345 -h127.0.0.1 shutdown</span><br></pre></td></tr></table></figure>
<h5 id="备份和删除历史数据">备份和删除历史数据</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /data/mysql/mysql_3306 /data/mysql/mysql_3306_backup_20220325</span><br></pre></td></tr></table></figure>
<h5 id="创建新的数据文件夹">创建新的数据文件夹</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/mysql/mysql_3306</span><br></pre></td></tr></table></figure>
<h5 id="数据恢复-v2">数据恢复</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innobackupex --defaults-file=/data/mysql/mysql_3306/my_3306.cnf --host=127.0.0.1 --port=3306 --user=root --password=123456 --copy-back /data/backup_20220325/2022-03-25_14-49-59</span><br></pre></td></tr></table></figure>
<h5 id="授权数据文件夹给mysql用户">授权数据文件夹给mysql用户</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /data/mysql</span><br><span class="line"></span><br><span class="line">chown -R mysql:mysql mysql_3306</span><br></pre></td></tr></table></figure>
<h5 id="启动数据库">启动数据库</h5>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/mysql/mysql_3306</span><br><span class="line">sh start.sh</span><br></pre></td></tr></table></figure>
<h4 id="添加主从复制配置">添加主从复制配置</h4>
<p>查看data/xtrabackup_binlog_pos_innodb获取主从同步的位置。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># 添加主从配置</span><br><span class="line">CHANGE MASTER <span class="keyword">TO</span></span><br><span class="line">  MASTER_HOST<span class="operator">=</span><span class="string">&#x27;172.99.0.31&#x27;</span>,</span><br><span class="line">  MASTER_USER<span class="operator">=</span><span class="string">&#x27;rep&#x27;</span>,</span><br><span class="line">  MASTER_PASSWORD<span class="operator">=</span><span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">  MASTER_PORT<span class="operator">=</span><span class="number">3306</span>,</span><br><span class="line">  MASTER_LOG_FILE<span class="operator">=</span><span class="string">&#x27;mysql-bin.003637&#x27;</span>,</span><br><span class="line">  MASTER_LOG_POS<span class="operator">=</span><span class="number">103905709</span>,</span><br><span class="line">  MASTER_CONNECT_RETRY<span class="operator">=</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"># 查看主从同步配置</span><br><span class="line"><span class="keyword">show</span> slave status \G</span><br><span class="line"># 启动主从同步</span><br><span class="line"><span class="keyword">start</span> slave;</span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line"><span class="keyword">show</span> slave status \G</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> slave status \G</span><br><span class="line"><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span> <span class="number">1.</span> <span class="type">row</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master <span class="keyword">to</span> send event</span><br><span class="line">                  Master_Host: <span class="number">172.99</span><span class="number">.0</span><span class="number">.31</span></span><br><span class="line">                  Master_User: rep</span><br><span class="line">                  Master_Port: <span class="number">3306</span></span><br><span class="line">                Connect_Retry: <span class="number">10</span></span><br><span class="line">              Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.003637</span></span><br><span class="line">          Read_Master_Log_Pos: <span class="number">108431943</span></span><br><span class="line">               Relay_Log_File: relay<span class="operator">-</span>log<span class="number">.000002</span></span><br><span class="line">                Relay_Log_Pos: <span class="number">749241</span></span><br><span class="line">        Relay_Master_Log_File: mysql<span class="operator">-</span>bin<span class="number">.003637</span></span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB: mysql,test,information_schema</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table:</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: <span class="number">0</span></span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: <span class="number">0</span></span><br><span class="line">          Exec_Master_Log_Pos: <span class="number">105389363</span></span><br><span class="line">              Relay_Log_Space: <span class="number">2847004</span></span><br><span class="line">              Until_Condition: <span class="keyword">None</span></span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: <span class="number">0</span></span><br><span class="line">           Master_SSL_Allowed: <span class="keyword">No</span></span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: <span class="number">3177</span></span><br><span class="line">Master_SSL_Verify_Server_Cert: <span class="keyword">No</span></span><br><span class="line">                Last_IO_Errno: <span class="number">0</span></span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: <span class="number">0</span></span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: <span class="number">523306</span></span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">                   Using_Gtid: <span class="keyword">No</span></span><br><span class="line">                  Gtid_IO_Pos:</span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>
<h2 id="错误记录">错误记录</h2>
<h3 id="xtrabackup-Can’t-change-dir-to-‘-var-lib-mysql’-Errcode-2-No-such-file-or-directory">xtrabackup: Can’t change dir to ‘/var/lib/mysql’ (Errcode: 2 - No such file or directory)</h3>
<h5 id="错误场景">错误场景</h5>
<p>在运行备份命令<code>innobackupex --defaults-file=/root/master/config-file.cnf --host=127.0.0.1 --port=3306 --user=root --password=123456 /root/backup</code>时报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost master]# innobackupex --defaults-file=/root/master/config-file.cnf --host=127.0.0.1 --port=3306 --user=root --password=123456 /root/backup</span><br><span class="line">xtrabackup: recognized server arguments: --log_bin --server-id=2481903306</span><br><span class="line">xtrabackup: recognized client arguments:</span><br><span class="line">220324 18:36:59 innobackupex: Starting the backup operation</span><br><span class="line"></span><br><span class="line">IMPORTANT: Please check that the backup run completes successfully.</span><br><span class="line">           At the end of a successful backup run innobackupex</span><br><span class="line">           prints &quot;completed OK!&quot;.</span><br><span class="line"></span><br><span class="line">220324 18:36:59  version_check Connecting to MySQL server with DSN &#x27;dbi:mysql:;mysql_read_default_group=xtrabackup;host=127.0.0.1;port=3306&#x27; as &#x27;root&#x27;  (using password: YES).</span><br><span class="line">220324 18:36:59  version_check Connected to MySQL server</span><br><span class="line">220324 18:36:59  version_check Executing a version check against the server...</span><br><span class="line">220324 18:36:59  version_check Done.</span><br><span class="line">220324 18:36:59 Connecting to MySQL server host: 127.0.0.1, user: root, password: set, port: 3306, socket: not set</span><br><span class="line">Using server version 10.1.32-MariaDB-1~jessie</span><br><span class="line">innobackupex version 2.4.24 based on MySQL server 5.7.35 Linux (x86_64) (revision id: b4ee263)</span><br><span class="line">xtrabackup: uses posix_fadvise().</span><br><span class="line">innobackupex: Can&#x27;t change dir to &#x27;/var/lib/mysql/&#x27; (Errcode: 2 - No such file or directory)</span><br><span class="line">xtrabackup: cannot my_setwd /var/lib/mysql/</span><br></pre></td></tr></table></figure>
<h5 id="解决方案">解决方案</h5>
<p>不可以在其他服务器上运行innobackupex命令对mysql进行备份</p>
<p>参考：<a target="_blank" rel="noopener" href="https://serverfault.com/questions/685279/can-i-run-percona-xtrabackup-on-my-desktop">https://serverfault.com/questions/685279/can-i-run-percona-xtrabackup-on-my-desktop</a></p>
<h3 id="ERROR-Can’t-start-server-Bind-on-TCP-IP-port-Got-error-98-Address-already-in-use">[ERROR] Can’t start server: Bind on TCP/IP port. Got error: 98: Address already in use</h3>
<p>第一次启动数据库报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">220325 16:16:17 mysqld_safe Starting mysqld daemon with databases from &#x2F;data&#x2F;mysql&#x2F;mysql_3306&#x2F;data</span><br><span class="line">220325 16:16:17 [Note] &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld (mysqld 10.0.28-MariaDB-enterprise) starting as process 19969 ...</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Using mutexes to ref count buffer pool pages</span><br><span class="line">220325 16:16:17 [Note] InnoDB: The InnoDB memory heap is disabled</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Mutexes and rw_locks use GCC atomic builtins</span><br><span class="line">220325 16:16:17 [Note] InnoDB: GCC builtin __sync_synchronize() is used for memory barrier</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Compressed tables use zlib 1.2.3</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Using Linux native AIO</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Using CPU crc32 instructions</span><br><span class="line">220325 16:16:17 [Note] InnoDB: Initializing buffer pool, size &#x3D; 50.0G</span><br><span class="line">220325 16:16:19 [Note] InnoDB: Completed initialization of buffer pool</span><br><span class="line">220325 16:16:19 [Note] InnoDB: Highest supported file format is Barracuda.</span><br><span class="line">220325 16:16:20 [Note] InnoDB: 128 rollback segment(s) are active.</span><br><span class="line">220325 16:16:20 [Note] InnoDB:  Percona XtraDB (http:&#x2F;&#x2F;www.percona.com) 5.6.32-79.0 started; log sequence number 836023388696</span><br><span class="line">2022-03-25 16:16:20 7f6e1bfe8700 InnoDB: Loading buffer pool(s) from .&#x2F;&#x2F;ib_buffer_pool</span><br><span class="line">220325 16:16:20 [Note] Server socket created on IP: &#39;::&#39;.</span><br><span class="line">220325 16:16:20 [ERROR] Can&#39;t start server: Bind on TCP&#x2F;IP port. Got error: 98: Address already in use</span><br><span class="line">220325 16:16:20 [ERROR] Do you already have another mysqld server running on port: 3306 ?</span><br><span class="line">220325 16:16:20 [ERROR] Aborting</span><br><span class="line"></span><br><span class="line">220325 16:16:20 [Note] unregister_replicator OK</span><br><span class="line">220325 16:16:20 [Note] InnoDB: FTS optimize thread exiting.</span><br><span class="line">220325 16:16:20 [Note] InnoDB: Starting shutdown...</span><br><span class="line">2022-03-25 16:16:20 7f6e1bfe8700 InnoDB: Buffer pool(s) load completed at 220325 16:16:20</span><br><span class="line">2022-03-25 16:16:20 7f6e1bfe8700 InnoDB: Dumping buffer pool(s) to .&#x2F;&#x2F;ib_buffer_pool</span><br><span class="line">2022-03-25 16:16:20 7f6e1bfe8700 InnoDB: Buffer pool(s) dump completed at 220325 16:16:20</span><br><span class="line">220325 16:16:21 [Note] InnoDB: Waiting for page_cleaner to finish flushing of buffer pool</span><br><span class="line">220325 16:16:23 [Note] InnoDB: Shutdown completed; log sequence number 836023391393</span><br><span class="line">220325 16:16:23 [Note] &#x2F;usr&#x2F;local&#x2F;mysql&#x2F;bin&#x2F;mysqld: Shutdown complete</span><br><span class="line"></span><br><span class="line">220325 16:16:23 mysqld_safe mysqld from pid file &#x2F;data&#x2F;mysql&#x2F;mysql_3306&#x2F;data&#x2F;172-22-0-32.pid ended</span><br></pre></td></tr></table></figure>
<h4 id="解决方案-v2">解决方案</h4>
<p>查看占用3306端口的进程（<code>lsof -i TCP:3306</code>)，杀掉此进程之后再重新启动。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">背景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.1.</span> <span class="toc-text">基本信息</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C%E5%A6%82%E4%B8%8B"><span class="toc-number">2.</span> <span class="toc-text">具体操作如下</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85Percona-XtraBackup"><span class="toc-number">2.1.</span> <span class="toc-text">安装Percona XtraBackup</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">2.1.0.1.</span> <span class="toc-text">错误处理</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Percona-XtraBackup"><span class="toc-number">2.2.</span> <span class="toc-text">使用Percona XtraBackup</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%87%E4%BB%BDmaster"><span class="toc-number">2.2.1.</span> <span class="toc-text">备份master</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">2.2.2.</span> <span class="toc-text">数据文件一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D"><span class="toc-number">2.2.3.</span> <span class="toc-text">数据恢复</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%8A%E5%A4%87%E4%BB%BD%E6%95%B0%E6%8D%AEcopy%E5%AF%BC32%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">2.2.3.1.</span> <span class="toc-text">把备份数据copy导32服务器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2mysql"><span class="toc-number">2.2.3.2.</span> <span class="toc-text">停止mysql</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E5%92%8C%E5%88%A0%E9%99%A4%E5%8E%86%E5%8F%B2%E6%95%B0%E6%8D%AE"><span class="toc-number">2.2.3.3.</span> <span class="toc-text">备份和删除历史数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%96%B0%E7%9A%84%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">2.2.3.4.</span> <span class="toc-text">创建新的数据文件夹</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D-v2"><span class="toc-number">2.2.3.5.</span> <span class="toc-text">数据恢复</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8E%88%E6%9D%83%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E5%A4%B9%E7%BB%99mysql%E7%94%A8%E6%88%B7"><span class="toc-number">2.2.3.6.</span> <span class="toc-text">授权数据文件夹给mysql用户</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">2.2.3.7.</span> <span class="toc-text">启动数据库</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">2.2.4.</span> <span class="toc-text">添加主从复制配置</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E8%AE%B0%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">错误记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#xtrabackup-Can%E2%80%99t-change-dir-to-%E2%80%98-var-lib-mysql%E2%80%99-Errcode-2-No-such-file-or-directory"><span class="toc-number">3.1.</span> <span class="toc-text">xtrabackup: Can’t change dir to ‘&#x2F;var&#x2F;lib&#x2F;mysql’ (Errcode: 2 - No such file or directory)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%9C%BA%E6%99%AF"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">错误场景</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">3.1.0.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERROR-Can%E2%80%99t-start-server-Bind-on-TCP-IP-port-Got-error-98-Address-already-in-use"><span class="toc-number">3.2.</span> <span class="toc-text">[ERROR] Can’t start server: Bind on TCP&#x2F;IP port. Got error: 98: Address already in use</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-v2"><span class="toc-number">3.2.1.</span> <span class="toc-text">解决方案</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&text=MySQL数据库备份并添加主从复制"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&is_video=false&description=MySQL数据库备份并添加主从复制"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=MySQL数据库备份并添加主从复制&body=Check out this article: https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&title=MySQL数据库备份并添加主从复制"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&name=MySQL数据库备份并添加主从复制&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://guozhe001.github.io/2024/11/22/others/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD%E5%B9%B6%E6%B7%BB%E5%8A%A0%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/&t=MySQL数据库备份并添加主从复制"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020-2024
    guozhe
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/guozhe001">项目</a></li>
         
          <li><a href="/search/">搜索</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
